---
title: "Habitat Recovery"
output: html_document
---
```{r tips & tutorials}


# filtering across multiple columns https://suzan.rbind.io/2018/02/dplyr-tutorial-3/#filtering-across-multiple-columns 


############################################################################
# FACET WRAPS & CUSTOM AXES
############################################################################

# multi-panel plots http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/#create-some-plots 

#http://zevross.com/blog/2019/04/02/easy-multi-panel-plots-in-r-using-facet_wrap-and-facet_grid-from-ggplot2/

# ggplot customization, esp. legends http://r-statistics.co/Complete-Ggplot2-Tutorial-Part2-Customizing-Theme-With-R-Code.html#Legend%20Labels%20and%20Point%20Color

# https://www.datanovia.com/en/blog/ggplot-axis-ticks-set-and-rotate-text-labels/

# http://www.sthda.com/english/wiki/ggplot2-axis-ticks-a-guide-to-customize-tick-marks-and-labels

# https://www.datanovia.com/en/blog/ggplot-legend-title-position-and-labels/

############################################################################
# COLOR BREWER
############################################################################

#color brewer palettes for ggplot, including colorblind-friendly. See https://www.datanovia.com/en/blog/the-a-z-of-rcolorbrewer-palette/ or https://www.datanovia.com/en/blog/r-colors-amazing-resources-you-want-to-know/
# https://www.datanovia.com/en/blog/ggplot-colors-best-tricks-you-will-love/

# 1. Visualize a single RColorBrewer palette by specifying its name
#display.brewer.pal(8, name)

# 2. Return the hexadecimal color code of the palette
#brewer.pal(n, name)

brewer.pal(n=11,"PRGn")

# NRE = blue "#1F78B4"
# LQRE = red "#E31A1C" 
# ERE = yellow "#FFD92F"

#Grubbed = "#40004B"
#Excl1 = "#9970AB"
#Excl10 = "#5AAE61"
#Undisturbed = "#00441B"

# Forb = "#BC80BD"
# Non-native graminoid = "#FDB462"
# Native graminoid = "#B3DE69"
# Groundcover = "#80B1D3"
#fn gps mycol = c("#80B1D3", "#B3DE69", "#FDB462", "#BC80BD")

```

```{r library setup, include=FALSE}

library(dplyr)
library(plyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(stats)
library(ape)
library(vegan)
library(lme4)
library(RColorBrewer)
library(RVAideMemoire)
library(reshape2)
library(kableExtra)


```

Preliminary data organization & transformations 
```{r veg data setup}

#d_mie <- read.csv("mie.csv") 
raw.mie <- read.csv("mie_raw.csv")
#View(raw.mie)

#fngp are fine-scale groups; fngp2 are coarser groupings

mie <- raw.mie %>% 
  filter(!estuary == "ere") %>% 
  pivot_longer(agre:bare, 
               names_to  = "species", 
               values_to = "cover") %>%
  mutate(obs = "veg") %>% 
  mutate(endemic = ifelse(species %in% c("agre", "agsp", "atpa", "coco", "caca"), "Invasive",
                   
                          ifelse(species %in% "bare", "Unvegetated", "Native"))) %>% 
  mutate(life = ifelse(species %in% c("atpa", "pofo", "sade", "spca"), 
                              "Annual", 
                       ifelse(species %in% "bare", "Unvegetated", "Perennial"))) %>% 
  mutate(root = ifelse(species %in% c("atpa", "daca", "pofo", "trwo"), "Taproot", 
                ifelse(species %in% c("coco", "dece", "sade"), "Fibrous",
                ifelse(species %in% "bare", "Unvegetated", "Rhizomatous")))) %>% 
  mutate(clade = ifelse(species %in% c("agre", "agsp", "caly", "dece", "disp", 
                                       "juba"), "Select Graminoid", 
                ifelse(species %in% c("agre", "agsp", "caly", "dece", "disp", 
                                      "elpar", "juba"), "All Graminoid",
                ifelse(species %in% "bare", "Unvegetated", "Forb")))) %>% 
  mutate(fngp = ifelse(species %in% c("agre", "agsp", "caly", "disp", "juba", "elpar"), "Perennial graminoid, rhizomatous roots",
                  ifelse(species %in% c("dece"), "Perennial graminoid,  fibrous roots",
                  ifelse(species %in% c("atpa", "pofo", "sade", "spca"), "Annual forb", 
                  ifelse(species %in% c("coco", "daca", "trwo"), "Perennial forb,  fibrous roots",
                  ifelse(species %in% c("trma", "glma", "popa", "sysu"), 
                         "Perennial forb,  rhizomatous roots", "Unvegetated")))))) %>% 
  mutate(fngp2 = ifelse(species %in% c("agre", "agsp", "caly", "disp", "juba", "dece", "elpar"), "Perennial graminoid",
                  ifelse(species %in% c("atpa", "pofo", "sade", "spca"), "Annual forb",
                  ifelse(species %in% c("bare"), "Unvegetated", "Perennial forb")))) %>% 
  mutate(structure = ifelse(species %in% c("bare"), "Unvegetated", 
                     ifelse(species %in% c("coco", "disp", "glma", "elpar", "pofo", "popa", "sade", "spca", "trwo"), "short", 
                     ifelse (species %in% c("agsp", "atpa", "daca", "juba", "sysu", "trma"), "med", "tall")))) # short = < 50 cm; med = 50 - 1 m, tall = > 1 m, per eflora BC

unique(mie$species)

mie$estuary <- factor(mie$estuary, levels = c("nre", "lqre"))
# mie$id <- as.character(mie$id)
# View(mie)
#head(mie)
# unique(mie$fngp2)
```

```{r seed data setup}

d.seed <- read.csv("seeds.csv")
head(d.seed)
# unique(d.seed$species)
#    "sama"  
#    

seed <- d.seed %>% 
  filter(!estuary == "ere") %>% 
  select(-c("id", "latin")) %>% 
  mutate(obs = "seed") %>% 
  mutate(endemic = ifelse(species %in% c("agsp", "atpa", "coco", "cirsp", "poasp"), "Invasive", "Native")) %>% 
  mutate(life = ifelse(species %in% c("atpa", "isce","jubu", "sade", "spca", "poasp"), "Annual", "Perennial")) %>% 
  mutate(root = ifelse(species %in% c("atpa", "cirsp", "coco", "dece", "grsp", "isce", "jute", "sade", "sama",                                               "poasp"), "Fibrous", "Rhizomatous")) %>% 
  mutate(clade = ifelse(species %in% c("agsp", "caly", "dece", "elpar", "isce", "juar", "juba", "juen", "jute",                                               "poasp"), "Graminoid", "Forb")) %>% 
  mutate(fngp = ifelse(species %in% c("agsp", "caly", "elpar", "juar", "juba", "juen"), "Perennial graminoid,                                               rhizomatous roots",                  
                ifelse(species %in% c("dece", "jute"), "Perennial graminoid,  fibrous roots",
                ifelse(species %in% c("atpa", "sade", "spca"), "Annual forb", "Perennial forb")))) %>% 
   mutate(fngp2 = ifelse(species %in% c("agsp", "caly", "juar", "juen", "juba", "jute", "dece", "elpar"), "Perennial graminoid",
                ifelse(species %in% c("isce", "jubu"), "Annual graminoid", 
                ifelse(species %in% c("atpa", "sade", "spca"), "Annual forb", "Perennial forb")))) %>% 
   mutate(structure = ifelse(species %in% c("coco", "isce" , "glma", "elpar", "jute", "popa", "sade", "sama", "spca"), "short", 
                  ifelse (species %in% c("achmi", "agsp", "atpa", "epgl", "grsp", "juar", "juba", "juen", "sysu", "trma"), "med", "tall"))) %>%  # short = < 50 cm; med = 50 - 1 m, tall = > 1 m, per eflora BC
  mutate(abund.m2 = count*85.5) %>%  # 85.5 multiplier estimates sample area of ~ 117 cm2 to fill 1 m2 (10,000 cm2) 
  group_by(estuary, disturbance, replicate, species) %>% 
  dplyr::mutate(id = replicate + 100) %>% 
  dplyr::rename(ct = count)

#which(is.na(seed))

seed$id <- as.character(seed$id)
seed$ct <- as.double(seed$ct)

#View(seed)
#head(seed)
#unique(seed$fngp2)

# dup.seed <- seed %>% 
#   group_by(estuary, season, disturbance, id, species) %>% 
#   filter(n()>1) %>% 
#   dplyr::summarize(n=n())


pfgcol <- c("#CC79A7", "#FF7F00", "#A6CEE3", "#0072B2", "#B2DF8A", "#009E73", "#999999")  
facet_labels <- c(nre = "Nanaimo", lqre = "Little Qualicum")
season_labels <- c(summer = "Summer 2021", fall = "Autumn 2021", spring = "Spring 2022")
disturb_labels <- c(grubbed = "Grubbed", excl1 = "Heavily Grazed, \nExclosed 1 year", excl10 = "Heavily Grazed, \nExclosed 10 years", reference = "Undisturbed")
structure_labels <- c(short = "Short (< 50 cm)", med = "Medium (50-100 cm)", tall = "Tall (> 100 cm)", Unvegetated = "Unvegetated")
clade_labels <- c(Forb = "Forb", Graminoid = "Graminoid", "Unvegetated" = "Unvegetated")


mie$estuary = factor(mie$estuary, 
                     levels = c("nre", "lqre"), 
                     labels = c("Nanaimo", "Little Qualicum"))
mie$disturbance = factor(mie$disturbance,
                            levels = c("grubbed", "excl1", "excl10", "reference"),
                            labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))


  
```

```{r calc relabund in all seed & veg}

# transform seed data into relative abundance (ra)
#head(seed)
#View(seed)
seed.select <- seed %>% 
  select(-c(life, root, abund.m2)) %>% 
  mutate(obs = "seed") %>% 
  unite(endemic.fngp2, c(endemic, fngp2), sep = " ", remove = FALSE)
#View(seed.select)
#View(seed)

seed.rel <- seed.select %>% 
  #arrange(estuary, season, disturbance, id) %>%
  group_by(estuary, season, disturbance, id) %>% 
  dplyr::summarize(sum.seed = sum(ct),
                   seed.ra = (ct/sum.seed)*100,
                   species = species) %>%
  ungroup()
#View(seed.rel)

seed.ra <- seed.select %>%
  left_join(seed.rel) %>% 
  dplyr::rename(rel.abund = seed.ra) 

#View(seed.ra)
# which(is.na(seed.ra))

# cover was entered as relative abundance in raw data. rename 'cover' as 'rel.abund'
mie.ra <- mie %>%
  select(-c(site, sal, elev, life, root)) %>% 
  group_by(id, endemic, fngp2)  %>% 
  mutate(obs = ifelse(species %in% "bare", "bare", "veg")) %>% 
  unite(endemic.fngp2, c(endemic, fngp2), sep = " ", remove = FALSE) %>% 
    dplyr::rename(rel.abund = cover) %>% 
   filter_at(vars("rel.abund"), any_vars(. != 0)) %>% 
  mutate(season = "summer")
# View(mie.ra)

mie.ra$estuary <- as.character(mie.ra$estuary)

#View(mie.ra)
# which(is.na(mie.ra))

# join dataframes
# colnames(mie.ra)
# colnames(seed.ra)

ra.join <- mie.ra %>% 
  full_join(seed.ra, by = c("estuary", "disturbance", "id","species","clade", "obs","endemic.fngp2", "endemic","fngp", "fngp2","rel.abund", "season", "structure")) %>% 
  unite(endemic.fngp2, c(endemic, fngp2), sep = " ", remove = FALSE) %>% 
  ungroup() %>% 
   select(-c("ct", "endemic","fngp","fngp2", "sum.seed", "replicate"))



#View(ra.join)
# which(is.na(ra.join))

```

``` {r calc presence/absence in summer seed & veg}

# transform data into presence absence (pa)
seed.pa <- seed %>% 
  #filter(season == "summer") %>% 
  mutate(ct=replace(ct, ct > 0, 1)) %>% # convert seed ct (abundance) to presence/absence
  pivot_wider(names_from = species, values_from = ct, values_fn = length) %>%
  #mutate_if(is.integer,as.numeric) %>% 
  mutate_all(~replace(., is.na(.), 0))  %>% 
  select(-c(life, root, clade, fngp, abund.m2))

  #mutate(across(popa:atpa, ~replace(., lengths(.) == 0, NA))) %>% 
# View(seed.pa)
# head(seed.pa)
# colnames(seed.pa)

mie.pa <- mie %>% 
  filter(!fngp2 == "Unvegetated") %>% 
  select(-c(site, sal, elev,life, root, clade, fngp)) %>% 
  mutate(cover=replace(cover, cover > 0, 1)) %>% 
  pivot_wider(names_from = species, values_from = cover) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>%
  mutate(season = "summer") %>%
  relocate(season, .before = endemic)
#head(mie.pa)
# View(mie.pa)
# which(is.na(mie.pa))
# join dataframes

pa.join <- mie.pa %>% 
  full_join(seed.pa, by = c("estuary", "endemic", "fngp2", "disturbance", "id", "obs", "season", "structure", "agsp", "caly", "coco", "glma", "elpar", "juba", "sade", "spca", "sysu", "trma")) %>% 
  replace(is.na(.), 0) 

pa.join <- pa.join[which(rowSums(pa.join[,9:38]) > 0), ] # remove rows where all species columns = 0
#View(pa.join)
#ncol(pa.join) #38
#colnames(pa.join)
# which(is.na(pa.join))

```

NAS recommendations: % native vs. exotic, % sedge (or perennial graminoid), one diversity metric (richness, evenness, or both). Calculate by plot. 

Vegetation

```{r veg summary: native, exotic, sedge, richness}

veg.sum <- mie %>% 
  filter(!species == "bare") %>% 
  filter(cover != 0) %>% 
  group_by(id, disturbance, estuary) %>% 
  #na.omit() %>% 
  dplyr::summarize(native_rich = length(endemic[endemic == "Native"]), 
            exotic_rich = length(endemic[endemic == "Invasive"]), 
            total_rich = length(species[unique(species)]), 
            native_cover = sum(cover[endemic == "Native"]), 
            exotic_cover = sum(cover[endemic == "Invasive"]), 
            graminoid_cover = sum(cover[clade == "Select Graminoid"]),
            sedge_cover = sum(cover[species == "caly"]), 
            total_cover = sum(cover)) %>% 
  mutate(exotic_prop = exotic_cover/100, 
         graminoid_prop = graminoid_cover/100, 
         sedge_prop = sedge_cover/100, 
         total_prop = total_cover/100) %>% 
  mutate(across(7:13, round, 2))


#View(veg.sum)

#veg <- left_join(veg.sum, 
#                 mie[ ,c("estuary", "disturbance", "id", "sal", "elev")], 
#                 by = "id")
#which(is.na(veg))
#View(veg)  


```

```{r veg response boxplots}

# veg$estuary = factor(veg$estuary, 
#                      levels = c("ere", "nre", "lqre"), 
#                      labels = c("Englishman", "Nanaimo", "Little Qualicum"))
# veg$disturbance = factor(veg$disturbance,
#                             levels = c("grubbed", "excl1", "excl10", "reference"),
#                             labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))

disturb_levels <- c('grubbed', 'excl1', 'excl10', 'reference')

cover_graminoid <- veg.sum %>% 
  ggplot(aes(x = disturbance, y = graminoid_cover, fill = estuary)) +
  geom_boxplot() + geom_jitter(width = 0.1, alpha = 0.2) +
  #facet_wrap(~estuary, scales = "free") +
  theme_classic() +
  labs(x = "Disturbance condition", y = "Graminoid cover, \nexcluding Eleocharis parvula (%)") +
   theme_classic()+
   theme(text = element_text(size = 12), 
           panel.spacing.x = unit(1.25, "lines"), 
           axis.text.x = element_text(angle = 25, hjust = 1)) +
  theme(plot.margin = unit(c(3,3,3,3), "lines")) +
  scale_x_discrete(limits = disturb_levels)

# cover_sedge <- veg.sum %>% 
#   ggplot(aes(x = disturbance, y = sedge_cover, fill = estuary)) +
#   geom_boxplot() + geom_jitter(width = 0.1, alpha = 0.2) +
#   #facet_wrap(~estuary, scales = "free") +
#   theme_classic() +
#   labs(x = "Disturbance condition", y = "Sedge cover (%)") +
#    theme_classic()+
#    theme(text = element_text(size = 12), 
#            panel.spacing.x = unit(1.25, "lines"), 
#            axis.text.x = element_text(angle = 25, hjust = 1)) +
#   scale_x_discrete(limits = disturb_levels)

# cover_total <- veg.sum %>% 
#   ggplot(aes(x = disturbance, y = total_cover, fill = estuary)) +
#   geom_boxplot() + geom_jitter(width = 0.1, alpha = 0.2) +
#   theme_classic() +
#   labs(x = "Disturbance condition", y = "Total cover (%)") +
#    theme_classic()+
#    theme(text = element_text(size = 12), 
#            panel.spacing.x = unit(1.25, "lines"), 
#            axis.text.x = element_text(angle = 25, hjust = 1)) +
#     scale_x_discrete(limits = disturb_levels)


cover_exotic <- veg.sum %>% 
  ggplot(aes(x = disturbance, y = exotic_cover, fill = estuary)) +
  geom_boxplot() + geom_jitter(width = 0.1, alpha = 0.2) +
  theme_classic() +
  labs(x = "Disturbance condition", y = "Exotic cover (%)") +
   theme_classic()+
   theme(text = element_text(size = 12), 
           panel.spacing.x = unit(1.25, "lines"), 
           axis.text.x = element_text(angle = 25, hjust = 1)) +
  theme(plot.margin = unit(c(3,3,3,3), "lines")) +
  scale_x_discrete(limits = disturb_levels)

rich_total <- veg.sum %>% 
  ggplot(aes(x = disturbance, y = total_rich, fill = estuary)) +
  geom_boxplot() + geom_jitter(width = 0.1, alpha = 0.2) +
  theme_classic() +
  labs(x = "Disturbance condition", y = "Total Richness") +
   theme_classic()+
   theme(text = element_text(size = 12), 
           panel.spacing.x = unit(1.25, "lines"), 
           axis.text.x = element_text(angle = 25, hjust = 1))  +
  theme(plot.margin = unit(c(3,3,3,3), "lines")) +
  scale_x_discrete(limits = disturb_levels)

rich_exotic <- veg.sum %>% 
  ggplot(aes(x = disturbance, y = exotic_rich, fill = estuary)) +
  geom_boxplot() + geom_jitter(width = 0.1, alpha = 0.2) +
  theme_classic() +
  labs(x = "Disturbance condition", y = "Exotic Richness") +
   theme_classic()+
   theme(text = element_text(size = 12), 
           panel.spacing.x = unit(1.25, "lines"), 
           axis.text.x = element_text(angle = 25, hjust = 1))  +
  theme(plot.margin = unit(c(3,3,3,3), "lines")) +
  scale_x_discrete(limits = disturb_levels)

panel_veg <- ggarrange(rich_total, rich_exotic, cover_graminoid, cover_exotic, 
                       common.legend = TRUE, legend = "bottom",
                       ncol = 2, nrow = 2, 
                       widths = c(2, 2)) #%>% 
             #annotate_figure(bottom = text_grob("text here", hjust = 1, x = 1,  size = 20))
panel_veg




```


``` {r standardized response}
# 1. drop ere, calculate mean reference values for different responses of interest by estuary & disturbance (exotic cover, sedge cover, etc), and mutate as new column.  
# 2. Convert disturbance categories to ordinal (numeric) values 0, 1, 10 s.t. # years exclosed = continuous predictor variable
# 3. create histogram of reponse variable to assess distribution. 
#View(veg.sum)

std_ref <- veg.sum %>% 
  group_by(estuary) %>% 
  dplyr::summarize(ref_mean_native_rich = mean(native_rich[disturbance == "reference"]), 
                   ref_mean_exotic_rich = mean(exotic_rich[disturbance == "reference"]),
                   ref_mean_total_rich = mean(total_rich[disturbance == "reference"]), 
                   ref_mean_exotic = mean(exotic_cover[disturbance == "reference"]), 
                   ref_mean_total = mean(total_cover[disturbance == "reference"]), 
                   ref_mean_sedge = mean(sedge_cover[disturbance == "reference"]), 
                   ref_mean_graminoid = mean(graminoid_cover[disturbance == "reference"])) 
#View(std_ref)

ref_vals <- left_join(veg.sum, std_ref, 
                      by = c("estuary"))
#View(ref_vals)



std <- ref_vals %>% 
  filter(!disturbance == "reference") %>% 
  group_by(estuary, disturbance, id) %>% 
  mutate(std_native_rich = (native_rich - ref_mean_native_rich), 
         std_exotic_rich = (exotic_rich - ref_mean_exotic_rich),
         std_total_rich = (total_rich - ref_mean_total_rich),
         std_exotic_cover = (exotic_cover - ref_mean_exotic),
         std_total_cover = (total_cover - ref_mean_total),
         std_sedge_cover = (sedge_cover - ref_mean_sedge), 
         std_graminoid_cover = (graminoid_cover - ref_mean_graminoid)) %>% 
  select(estuary, disturbance, id, std_native_rich, std_exotic_rich, std_total_rich, 
         std_exotic_cover, std_total_cover, std_sedge_cover, std_graminoid_cover) %>% 
  mutate(disturbance = ifelse(disturbance %in% "grubbed", 0, 
                       ifelse(disturbance %in% "excl1", 1, 10))) 

std_summary <- std %>% 
  pivot_longer(std_native_rich:std_total_rich, 
               names_to  = "std_rich", 
               values_to = "rich") %>% 
  pivot_longer(std_exotic_cover:std_graminoid_cover, 
               names_to  = "std_cover", 
               values_to = "cover")

#View(std)
  
# hist of response variables
ggplot(std_summary, aes(x = rich, fill = std_rich)) +
  geom_histogram(position = "dodge", binwidth = 0.5) + 
  theme_classic() +
  facet_grid(disturbance ~ estuary)

ggplot(std_summary, aes(x = cover, fill = std_cover)) +
  geom_histogram(position = "dodge", binwidth = 10) + 
  theme_classic() +
  facet_grid(disturbance ~ estuary)

```

```{r box plots of standardized responses}

### boxplot of standardized responses
std$disturbance <- as.factor(std$disturbance)

std_gram_cover <- std %>% 
  ggplot(aes(x = disturbance, y = std_graminoid_cover, fill = estuary)) +
  geom_boxplot() + 
  geom_jitter(width = 0.1, alpha = 0.2) +
  #facet_wrap(~estuary, scales = "free") +
  theme_classic() +
  labs(x = "Disturbance (ordinal)", y = "Graminoid cover standardized to reference, \nexcluding Eleocharis parvula (%)") 
   theme_classic()+
   theme(text = element_text(size = 12),
           panel.spacing.x = unit(1.25, "lines"),
           axis.text.x = element_text(angle = 25, hjust = 1)) +
  theme(plot.margin = unit(c(3,3,3,3), "lines"))
std_gram_cover


std$disturbance = factor(std$disturbance,
                          levels = c(0, 1, 10), 
                          labels = c("grubbed", "excl1", "excl10"))
                         
std_exotic_cover <- std %>% 
  ggplot(aes(x = disturbance, y = std_exotic_cover, fill = estuary)) +
  geom_boxplot() + 
  geom_jitter(width = 0.1, alpha = 0.2) +
  theme_classic() +
  labs(x = "Disturbance (ordinal)", y = "Exotic cover standardized to reference (%)") +
   theme_classic()
   # theme(text = element_text(size = 12),
   #         panel.spacing.x = unit(1.25, "lines"),
   #         axis.text.x = element_text(angle = 25, hjust = 1)) #+
  # theme(plot.margin = unit(c(3,3,3,3), "lines")) 
std_exotic_cover


```

```{r models (choices remain)}

# https://towardsdatascience.com/random-effects-in-linear-models-15845b2540ac
# basics of glms https://www.geo.fu-berlin.de/en/v/soga/Basics-of-statistics/Logistic-Regression/Logistic-Regression-in-R---An-Example/index.html 

#library(sjPlot)

###############################
# Graminoid cover (except elpar)
###############################
veg.sum$disturbance <- factor(veg.sum$disturbance, levels = c("reference", "grubbed", "excl1", "excl10"))

graminoid_glm <- glm(graminoid_prop ~ disturbance + estuary, # (*can add estuary as a fixed effect (+ estuary); show no influence as supplement
                 family = 'binomial',
                 data = veg.sum) # binomial family appropriate for proportional data constrained 0:1. logit link is default.  

summary(graminoid_glm) # transform coefficients? see fn tab_model
summary(graminoid_glm)$coefficients
plot(graminoid_glm)
# tab_model(graminoid_glm) # this might not be helpful
# if using binomial, need to study how to interpret coefficients (*related to link function) - what does this mean for the values of plant cover

###############################
# Exotic cover 
###############################
# Standardizing seems to help error in exotic cover, however need to explain real-world effects. 
# note glm w/ gaussian distribution = lm
# try simulated data to test model fit (pg. 32 of ES 482/582 Lecture Notes (Chapter 4))

std_exotic_glm <- glm(std_exotic_cover ~ disturbance, 
                 data = std) 

summary(std_exotic_glm)
summary(std_exotic_glm)$coefficients # need to transform coefficients based on link function to match response variable (not model)
plot(std_exotic_glm)



## problem with this one is wildly huge error for excl1
# exotic_glm <- glm(exotic_prop ~ disturbance, # (*add estuary as a fixed effect and add as supplement to show no influence of estuary)
#                  family = 'binomial',
#                  data = veg.sum) # binomial family appropriate for proportional data constrained 0:1. logit link is default.  
# 
# summary(exotic_glm)
# summary(exotic_glm)$coefficients
# plot(exotic_glm)
# tab_model(exotic_glm, transform = NULL) # this checks whether coefficients were transformed; doesn't matter, excl1 still weird


# # This one may not be needed since model with non-standardized data looked ok. Also, glm w/ gaussian distribution = lm. Still: if using standardized, need to be able to explain real-world implications of intercepts - try simulating data
# std_graminoid_glm <- glm(std_graminoid_cover ~ disturbance, 
#                  data = std) 
# summary(std_graminoid_glm)
# summary(std_graminoid_glm)$coefficients
# plot(std_graminoid_glm)



# My 3 options are: non-standardized responses w/ family = binomial distribution, OR standardized data with normal distribution (*glm w/ gaussian dist. = lm), OR fit data to a gamma distribution with standardized data to use the binomial distribution

# gamma distribution requires a sum value to make all values (+) (gamma accepts 0 to +oo)

```




Surface seed bank trends 

INCOMPLETE CHUNK: want to calculate similar metrics for seeds as for vegetation (richness of native/exotic, abundance or evenness of species, including select graminoids). As of Jul. 26, pasted code from veg summary, but have not edited for seeds. 
```{r seed summary: native, exotic, sedge, richness}
head(seed)
seed.sum <- seed %>% 
  filter(cover != 0) %>% 
  group_by(id, disturbance, estuary) %>% 
  #na.omit() %>% 
  dplyr::summarize(native_rich = length(endemic[endemic == "Native"]), 
            exotic_rich = length(endemic[endemic == "Invasive"]), 
            total_rich = length(species[unique(species)]), 
            #native_cover = sum(cover[endemic == "Native"]), 
            #exotic_cover = sum(cover[endemic == "Invasive"]), 
            graminoid_cover = sum(cover[clade == "Select Graminoid"]),
            sedge_cover = sum(cover[species == "caly"]), 
            total_cover = sum(cover)) %>% 
  mutate(exotic_prop = exotic_cover/100, 
         graminoid_prop = graminoid_cover/100, 
         sedge_prop = sedge_cover/100, 
         total_prop = total_cover/100) %>% 
  mutate(across(7:13, round, 2))
#View(veg.sum)

#veg <- left_join(veg.sum, 
#                 mie[ ,c("estuary", "disturbance", "id", "sal", "elev")], 
#                 by = "id")
#which(is.na(veg))
#View(veg)  

lm_nonstd_graminoid_cover <- lm(graminoid_cover ~ disturbance, 
                                data = veg.sum)
summary(lm_nonstd_graminoid_cover)
plot(lm_nonstd_graminoid_cover)



lmer_nonstd_graminoid_cover <- lmer(graminoid_cover ~ disturbance + (1|estuary), 
                                data = veg.sum)
summary(lmer_nonstd_graminoid_cover)

plot(lmer_nonstd_graminoid_cover)

# test whether log-likelihood ratio is different from zero
my_stat = 2*(logLik(lmer_nonstd_graminoid_cover) - logLik(lm_nonstd_graminoid_cover,REML = TRUE))

#bootstrap method to simulate the data under the null hypothesis (the simple linear model) and then generate a large number of likelihood ratio test statistics. https://towardsdatascience.com/random-effects-in-linear-models-15845b2540ac
LRT_stat = numeric(1000)
for(i in 1:1000){
  y = simulate(lm_nonstd_graminoid_cover)$sim_1
  null_md = lm(graminoid_cover ~ disturbance, 
                                data = veg.sum)
  mixed_md = lmer(graminoid_cover ~ disturbance + (1|estuary), 
                                data = veg.sum)
  LRT_stat[i] = as.numeric(2*(logLik(mixed_md) - logLik(null_md,REML = TRUE)))
}

sum(LRT_stat > my_stat)


```

``` {r surface seed bank trends - relative abundance of functional groups by season, means & SE}

## Duplicated rows are causing the SE overlapping - need to figure out why rows are repeated
seed.abund.mean <- seed.ra %>% 
  select(-c(ct, sum.seed)) %>% 
  group_by(season, estuary, disturbance, endemic.fngp2) %>%  
  dplyr::summarize(n = n(), 
                  seed.mean = mean(rel.abund), 
                  seed.sd = sd(rel.abund), 
                  seed.se = seed.sd/sqrt(rel.abund)) %>%  #, 
                  #endemic.fngp2 = endemic.fngp2) %>% 
   ungroup() %>% 
   mutate_all(~replace(., is.na(.), 0)) 
#View(seed.abund.mean)
#View(ra.join)
# View(seed.ra)


# unique(seed.abund.mean$endemic.fngp2)
# unique(seed.abund.mean$disturbance)

# is.na(seed.abund.mean)
# which(is.na(seed.abund.mean))

#### plot setup

seed.abund.mean$estuary = factor(seed.abund.mean$estuary, levels = c("ere", "nre", "lqre"))
seed.abund.mean$season = factor(seed.abund.mean$season, levels = c("summer", "fall", "spring"))

seed.abund.mean$disturbance = factor(seed.abund.mean$disturbance,
                                          levels = c("grubbed", "excl1", "excl10", "reference"),
                                          labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))
seed.abund.mean$endemic.fngp2 = factor(seed.abund.mean$endemic.fngp2,
                                          levels = c("Native Annual forb", "Invasive Annual forb", "Native Perennial forb", "Invasive Perennial forb", "Native Annual graminoid", "Invasive Annual graminoid", "Native Perennial graminoid", "Invasive Perennial graminoid"),
                                          labels = c("Annual Forb, Native", "Annual Forb, Invasive", "Perennial Forb, Native", "Perennial Forb, Invasive", "Annual Graminoid, Native", "Annual Graminoid, Invasive", "Perennial Graminoid, Native", "Perennial Graminoid, Invasive"))


pd <- position_dodge(0.4)
col.seed <- c("#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A", "#FFFF99", "#B15928", "#B2DF8A", "#33A02C", "#B3B3B3")
#brewer.pal(n= 12,"Paired")
# native = light, invasive = dark
# annual forb orange (native) "#FDBF6F" (invasive) "#FF7F00"
# perennial forb purple (native) "#CAB2D6" (invasive) "#6A3D9A" 
# annual graminoid yellow (native) "#FFFF99", (invasive) "#B15928"
#gramoind green (native) "#B2DF8A", (invasive) "#33A02C"
# Unvegetated = "#B3B3B3"


seed.abund <- seed.abund.mean %>% 
  ggplot(aes(x=disturbance, y=seed.mean, color = endemic.fngp2)) +   
  geom_point(size = 6, position = position_dodge(width = 0.4)) +
  ylim(0, 100)+
  # geom_errorbar(aes(ymin = ifelse(seed.mean - seed.se <0, 0, seed.mean - seed.se), 
  #                   ymax = ifelse(seed.mean + seed.se <0, 0, seed.mean + seed.se)), 
  #               width = .3, position = position_dodge(width = 0.4)) +
  labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", color = "Functional Group & \nEndemic Status") +
  theme_classic()+
  theme(text = element_text(size = 20), 
          panel.spacing.x = unit(1.25, "lines"), 
          axis.text.x = element_text(angle = 35, hjust = 1)) +
  facet_grid(season ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels, season = season_labels)) +
  theme(panel.spacing = unit(3, "lines")) +
  scale_color_manual(values = col.seed) 
seed.abund

```

```{r surface seed bank trends - relative abundance of clades & structure by season, means & SE}

seed.structure.mean <- seed.ra %>% 
  group_by(estuary, disturbance, obs, endemic, clade, structure) %>%  
  dplyr::summarize(sst.abund = n(),
            sst.abund.mean = mean(rel.abund), 
            sst.abund.sd = sd(rel.abund), 
            sst.abund.se = sst.abund.sd/sqrt(sst.abund)) %>% 
   mutate_all(~replace(., is.na(.), 0)) %>% 
  ungroup()
#View(seed.structure.mean)


############################# 
## All seasons, averaged
############################# 

seed.structure.mean$estuary = factor(seed.structure.mean$estuary, levels = c("ere", "nre", "lqre"))
seed.structure.mean$disturbance = factor(seed.structure.mean$disturbance,
                                          levels = c("grubbed", "excl1", "excl10", "reference"),
                                          labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))

seed.structure.mean$structure = factor(seed.structure.mean$structure, levels = c("tall", "med", "short"),
                                      labels = c("Tall (> 100 cm)", "Medium (50-100 cm)", "Short (< 50 cm)"))
seed.structure.mean$clade = factor(seed.structure.mean$clade, levels = c("Graminoid", "Forb"))

pd.structure <- position_dodge(0.5)
seed.structure.col <- c("#006837", "#41AB5D", "#ADDD8E")
 
 #brewer.pal(n= 9, "YlGn")
 # short =  "#ADDD8E", medium = "#41AB5D" , tall = "#006837"

seed.structure.abund <- seed.structure.mean %>% 
    ggplot(aes(x=disturbance, y=sst.abund.mean, color = structure, shape = endemic)) +
    geom_jitter(size = 7, position = pd.structure) +
    scale_y_continuous(limits = c(0, 100), breaks = c(0, 50, 100)) +
    geom_errorbar(aes(ymin = ifelse(sst.abund.mean - sst.abund.se <0, 0, sst.abund.mean - sst.abund.se),
                      ymax = sst.abund.mean + sst.abund.se),
                  width = .3, position = pd.structure) +
    labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", color = "Plant Height", shape = "Endemic") +
    theme_classic()+
    theme(text = element_text(size = 18), 
           panel.spacing.x = unit(1.25, "lines"), 
            axis.text.x = element_text(angle = 25, hjust = 1)) +
    facet_grid(clade ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels)) +
     theme(panel.spacing = unit(4, "lines")) +
    scale_color_manual(values = seed.structure.col) +
    scale_shape_manual(values = c(15, 18), limits = c("Native", "Invasive"))
seed.structure.abund
#ggsave("fig-meanse-seed-structure-abund.jpg", seed.structure.abund, width = 16, height = 8)



############################# 
## By season: filter to clade to make multi-panel plots
############################# 

seed.seasonal.mean <- seed.ra %>% 
  group_by(estuary, disturbance, obs, endemic, clade, structure, season) %>%  
  dplyr::summarize(sst.abund = n(),
            sst.abund.mean = mean(rel.abund), 
            sst.abund.sd = sd(rel.abund), 
            sst.abund.se = sst.abund.sd/sqrt(sst.abund)) %>% 
   mutate_all(~replace(., is.na(.), 0)) %>% 
  ungroup()
#View(seed.seasonal.mean)

### ~~~~~~~~~
# Graminoids
### ~~~~~~~~~
gram.struc <- seed.seasonal.mean %>% 
  filter(clade == "Graminoid")
#View(gram.struc)

gram.struc$estuary = factor(gram.struc$estuary, levels = c("ere", "nre", "lqre"))
gram.struc$disturbance = factor(gram.struc$disturbance,
                                          levels = c("grubbed", "excl1", "excl10", "reference"),
                                          labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))
gram.struc$structure = factor(gram.struc$structure, levels = c("tall", "med", "short"), 
                                      labels = c("Tall (> 100 cm)", "Medium (50-100 cm)", "Short (< 50 cm)")) 
gram.struc$season = factor(gram.struc$season, levels = c("summer", "fall", "spring"))

gram.struc.col <- c("#006D2C", "#41AE76", "#99D8C9")
#brewer.pal(n= 9, "BuGn") 
# short =  "#99D8C9", medium = "#41AE76" , tall = "#006D2C"

gram.struc.abund <- gram.struc %>% 
   ggplot(aes(x=disturbance, y=sst.abund.mean, color = structure, shape = endemic)) +
   geom_jitter(size = 7, position = pd.structure) +
   scale_y_continuous(limits = c(0, 100), breaks = c(0, 50, 100)) +
   geom_errorbar(aes(ymin = ifelse(sst.abund.mean - sst.abund.se <0, 0, sst.abund.mean - sst.abund.se),
                     ymax = sst.abund.mean + sst.abund.se),
                 width = .3, position = pd.structure) +
   labs(x = "Disturbance Condition", y = "Mean Relative Abundance (%)", title = "[A] Graminoids", color = "Plant Height", shape = "Endemic") +
   theme_classic()+
   theme(text = element_text(size = 18), 
           panel.spacing.x = unit(1.25, "lines"), 
           axis.text.x = element_text(angle = 25, hjust = 1)) +
    facet_grid(season ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels, season = season_labels)) +
    theme(panel.spacing = unit(4, "lines")) +
   scale_color_manual(values = gram.struc.col) +
   scale_shape_manual(values = c(15, 18), limits = c("Native", "Invasive"))
gram.struc.abund
#ggsave("fig-meanse-gram-structure-abund.jpg", gram.struc.abund, width = 15, height = 8)



### ~~~~~~~~~
# Forbs
### ~~~~~~~~~

forb.struc <- seed.seasonal.mean %>% 
  filter(clade == "Forb")

forb.struc$estuary = factor(forb.struc$estuary, levels = c("ere", "nre", "lqre"))
forb.struc$disturbance = factor(forb.struc$disturbance,
                                          levels = c("grubbed", "excl1", "excl10", "reference"),
                                          labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))
forb.struc$structure = factor(forb.struc$structure, levels = c("tall", "med", "short"), 
                                      labels = c("Tall (> 100 cm)", "Medium (50-100 cm)", "Short (< 50 cm)")) 
forb.struc$season = factor(forb.struc$season, levels = c("summer", "fall", "spring"))


forb.struc.col <- c("#4D004B", "#8C6BB1", "#9EBCDA")
 #brewer.pal(n= 9, "BuPu") 
 # short =  "#9EBCDA", medium = "#8C6BB1" , tall = "#4D004B"

forb.struc.abund <- forb.struc %>% 
   ggplot(aes(x=disturbance, y=sst.abund.mean, color = structure, shape = endemic)) +
   geom_jitter(size = 7, position = pd.structure) +
   scale_y_continuous(limits = c(0, 100), breaks = c(0, 50, 100)) +
   geom_errorbar(aes(ymin = ifelse(sst.abund.mean - sst.abund.se <0, 0, sst.abund.mean - sst.abund.se),
                     ymax = sst.abund.mean + sst.abund.se),
                 width = .3, position = pd.structure) +
   labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", title = "[B] Forbs", color = "Plant Height", shape = "Endemic") +
   theme_classic()+
   theme(text = element_text(size = 18), 
           panel.spacing.x = unit(1.25, "lines"), 
           axis.text.x = element_text(angle = 25, hjust = 1)) +
    facet_grid(season ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels, season = season_labels)) +
    theme(panel.spacing = unit(4, "lines")) +
   scale_color_manual(values = forb.struc.col) +
   scale_shape_manual(values = c(15, 18), limits = c("Native", "Invasive"))
forb.struc.abund
#ggsave("fig-meanse-forb-structure-abund.jpg", forb.struc.abund, width = 15, height = 8)


## panel format w/ ggpubr
seasonal.seed.meanse.panel <- ggarrange(gram.struc.abund, forb.struc.abund,
          common.legend = FALSE, legend = "right",
          ncol = 1, nrow = 2) %>% 
  annotate_figure(bottom = text_grob("Seasonal changes in species structural traits by plant clade", hjust = 1, x = 1,  size = 14))
seasonal.seed.meanse.panel

#ggsave("fig-meanse-seed-structure-seasonal-panel.jpg", seasonal.seed.meanse.panel, width = 16, height = 16)


```

``` {r seasonal surface seed bank NMDS by realbund}
# runs with seed.ra 

seasonal.ra <- seed.ra %>% 
  select(season, estuary, disturbance, id, species, rel.abund) %>% 
  pivot_wider(names_from = species, values_from = rel.abund) %>% 
  mutate_all(~replace(., is.na(.), 0)) 

#View(seasonal.ra)

# select only species
seasonal.sp = seasonal.ra[,5:ncol(seasonal.ra)]

############################################
#turn abundance data frame into a matrix
############################################
seasonal.matrix = as.matrix(seasonal.sp)
#View(seasonal.matrix)

############################################
# Stress
############################################
#all
set.seed(123)
nmds.seasonal.seed = metaMDS(seasonal.matrix, distance = "bray")
nmds.seasonal.seed
# stress = 0.134

############################################
#extract NMDS scores (x and y coordinates)
############################################
ds.seasonal.seed = as.data.frame(scores(nmds.seasonal.seed)$sites)
#View(ds.seasonal.seed)
#any(is.na(ds.seasonal.seed))

############################################
#add columns to data frame 
############################################
ds.seasonal.seed$season = seasonal.ra$season

ds.seasonal.seed$disturbance = seasonal.ra$disturbance

ds.seasonal.seed$estuary = seasonal.ra$estuary

# View(ds.seasonal.seed)

############################################
# PLOT
############################################

## all
ds.seasonal.seed$estuary = factor(ds.seasonal.seed$estuary, levels = c("nre", "lqre"))
ds.seasonal.seed$disturbance <- as.factor(ds.seasonal.seed$disturbance)

seasonal.seed.nmds = ggplot(ds.seasonal.seed, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance, shape = season)) + 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    facet_grid(. ~ estuary, labeller = labeller(estuary = facet_labels)) +
    labs(x = "NMDS1", colour = "Disturbance", shape = "Surface seed bank \nsampling season", y = "NMDS2", caption = "Relative compositional abundance of seasonal surface seed bank samples (Bray's distance), stress = 0.134")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
    scale_colour_brewer(palette = "PRGn", limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
    scale_shape_discrete(limits = c("summer", "fall", "spring"), labels = c("Summer 2021", "Fall 2021", "Spring 2022"))
seasonal.seed.nmds


```


Comparisons of vegetation to seed bank
Note - these NMDS plots don't seem to show much difference (points overlap); need to determine what/how ordination is measuring. 



```{r presence/absence NMDS of vegetation and summer seed bank, facet wrap by estuary}

#################################
## PERMANOVA using species presence with Bray's distance 
#################################
# Does composition presence/absence significantly differ between seed bank and vegetation? 

# PERMANOVA
# comp = pa.join[,7:ncol(pa.join)]
# comp.matrix <- vegdist(comp, method = 'bray')
# 
# # is.na(comp.matrix)
# # which(is.na(comp.matrix))
# 
# set.seed(42)
# permanova <- adonis2(comp.matrix ~ disturbance + obs + estuary, data = pa.join, permutations = 99, method = "bray")
# # Yes, compositional presence/absence is significantly different between disturbance conditions, estuaries, and veg. vs. seeds. 


##https://stats.stackexchange.com/questions/477826/how-is-pairwise-permanova-adonis-a-valid-non-parametric-approach-for-pairwise-co
# install.packages("pairwiseAdonis")
# library(pairwiseAdonis)
# pairwiseAdonis::pairwise.adonis(comp.matrix, pa.join[,7:35])

# https://www.researchgate.net/post/How_can_I_do_PerMANOVA_pairwise_contrasts_in_R


#################################
##3. NMDS based on species presence using Bray's distance
#################################

# matrix of species presence/absence
com = pa.join[,9:ncol(pa.join)]
#View(com)

#turn abundance data frame into a matrix
m.com = as.matrix(com)

set.seed(123)
nmds = metaMDS(m.com, distance = "bray")
nmds #stress = 0.0024 *no convergent soln
plot(nmds)
View(nmds)

#extract NMDS scores (x and y coordinates)
data.scores = as.data.frame(scores(nmds)$sites)
#View(data.scores)


#add columns to data frame 
data.scores$id = pa.join$id
data.scores$disturbance = pa.join$disturbance
data.scores$obs = pa.join$obs
data.scores$estuary = pa.join$estuary
data.scores$season = pa.join$season

# trying to add species labels following https://chrischizinski.github.io/rstats/vegan-ggplot2/
# species.scores <- as.data.frame(scores(nmds, "species"))
# species.scores$species <- rownames(species.scores)  # create a column of species, from the rownames of species.scores
# head(species.scores)


# add CI; see also https://stackoverflow.com/questions/36609476/ggplot2-draw-individual-ellipses-but-color-by-group
# library(ellipse)
# 
# df_ell <- data.frame() 
# for(g in levels(data.scores$disturbance)){df_ell <- rbind(df_ell, 
#       cbind(as.data.frame(with(data.scores[data.scores$disturbance==g,], 
#       ellipse(cor(NMDS1, NMDS2),scale=c(sd(NMDS1),sd(NMDS2)),centre=c(mean(NMDS1),mean(NMDS2))))),disturbance=g))} 


## plot

data.scores$estuary = factor(data.scores$estuary, levels = c("ere", "nre", "lqre"))
data.scores$disturbance <- as.factor(data.scores$disturbance)

pa.nmds = ggplot(data.scores, aes(x = NMDS1, y = NMDS2)) + 
    #geom_text(data=species.scores,aes(x=NMDS1,y=NMDS2,label=species),alpha=0.5) +
    geom_point(size = 6, aes( shape = obs, colour = season))+ 
    theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 14), 
    legend.text = element_text(size = 14, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance Condition", y = "NMDS2", shape = "Life Stage", caption = "Dissimilarity of species presence/absence using Euclidean distance, stress = 0.058")  + 
    facet_grid(disturbance ~ estuary, labeller = labeller(estuary = facet_labels)) + 
    theme(strip.text.x = element_text(size = 14, face = "bold")) +
    scale_colour_brewer(palette = "PRGn", limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
    scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Summer Seed Bank")) 

pa.nmds



```

```{r NMDS of relative abundance}

compare.ra <- ra.join %>% 
  ungroup() %>% 
  filter(!obs == "bare") %>% 
  pivot_wider(names_from = species, values_from = rel.abund) %>%
  replace(is.na(.), 0) 
#View(compare.ra)

#################################
## NMDS of species relative abundance 
#################################

#compare.ra.ere <- compare.ra %>% filter(estuary == "ere") 
#compare.ra.ere <- compare.ra.ere[which(rowSums(compare.ra.ere[,6:33]) > 0), ]


compare.ra.nre <- compare.ra %>% filter(estuary == "nre") 
#View(compare.ra.nre)
#nrow(compare.ra.nre) #300
#ncol(compare.ra.nre) #33

compare.ra.lqre <- compare.ra %>% filter(estuary == "lqre")
#View(compare.ra.lqre)
#nrow(compare.ra.lqre) #353
#ncol(compare.ra.lqre) #33

# matrix of species relative abundance

#ra.compare.ere = compare.ra.ere[,8:ncol(compare.ra.ere)]
ra.compare.nre = compare.ra.nre[,9:ncol(compare.ra.nre)]
ra.compare.lqre = compare.ra.lqre[,9:ncol(compare.ra.lqre)]
#View(compare.ra.nre)

#turn abundance data frame into a matrix
#mat.ra.ere = as.matrix(ra.compare.ere)
# nrow(mat.ra.ere) #63
# ncol(mat.ra.ere) #28
# View(mat.ra.ere)
#m.ra.ere <- m.ra.ere[which(rowSums(m.ra.ere) > 0), ] # remove rows where all species columns = 0

mat.ra.nre = as.matrix(ra.compare.nre)
#m.ra.nre <- m.ra.nre[which(rowSums(m.ra.nre) > 0), ]

mat.ra.lqre = as.matrix(ra.compare.lqre)
#m.ra.lqre <- m.ra.lqre[which(rowSums(m.ra.lqre) > 0), ]

# 
# set.seed(123)
# nmds.compare.ra.ere = metaMDS(mat.ra.ere, distance = "euclidean")
# nmds.compare.ra.ere
# stress = 0.132


set.seed(123)
nmds.compare.ra.nre = metaMDS(mat.ra.nre, distance = "euclidean")
nmds.compare.ra.nre
# stress = 0.0996

set.seed(123)
nmds.compare.ra.lqre = metaMDS(mat.ra.lqre, distance = "euclidean")
nmds.compare.ra.lqre
# stress = 0.0703


#extract NMDS data scores (x and y coordinates)

# ds.compare.ra.ere = as.data.frame(scores(nmds.compare.ra.ere)$sites)
ds.compare.ra.nre = as.data.frame(scores(nmds.compare.ra.nre)$sites)
ds.compare.ra.lqre = as.data.frame(scores(nmds.compare.ra.lqre)$sites)


#add columns to data frame 
# ds.compare.ra.ere$id = compare.ra.ere$id
ds.compare.ra.nre$id = compare.ra.nre$id
ds.compare.ra.lqre$id = compare.ra.lqre$id


# ds.compare.ra.ere$disturbance = compare.ra.ere$disturbance
ds.compare.ra.nre$disturbance = compare.ra.nre$disturbance
ds.compare.ra.lqre$disturbance = compare.ra.lqre$disturbance


# ds.compare.ra.ere$obs = compare.ra.ere$obs
ds.compare.ra.nre$obs = compare.ra.nre$obs
ds.compare.ra.lqre$obs = compare.ra.lqre$obs


# ds.compare.ra.ere$estuary = compare.ra.ere$estuary
ds.compare.ra.nre$estuary = compare.ra.nre$estuary
ds.compare.ra.lqre$estuary = compare.ra.lqre$estuary

# ds.compare.ra.ere$season = compare.ra.ere$season
ds.compare.ra.nre$season = compare.ra.nre$season
ds.compare.ra.lqre$season = compare.ra.lqre$season

# ds.compare.ra.ere$structure = compare.ra.ere$structure
ds.compare.ra.nre$structure = compare.ra.nre$structure
ds.compare.ra.lqre$structure = compare.ra.lqre$structure



########~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~``
### Plot
########~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~``

pd.nmds.ra <- position_dodge(0.74)
seasoncol = c("#7570B3", "#D95F02", "#1B9E77")
brewer.pal(n = 4, "Dark2")


# ## ERE
# ds.compare.ra.ere$disturbance = factor(ds.compare.ra.ere$disturbance, levels = c("grubbed", "reference"))
# 
# compare.ra.nmds.ere <- ds.compare.ra.ere %>% 
#     ggplot(aes(x = NMDS1, y = NMDS2, shape = obs, colour = season)) + 
#     geom_point(size = 6)+ 
#     theme(axis.text.y = element_text(colour = "black", size = 16), #face = "bold"
#     axis.text.x = element_text(colour = "black", size = 16), 
#     axis.title.x = element_text(face = "bold", size = 16, colour = "black"), 
#     legend.text = element_text(size = 16, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
#     legend.position = "right", axis.title.y = element_text(face = "bold", size = 16), 
#     legend.title = element_text(size = 16, colour = "black", face = "bold"), 
#     panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
#     legend.key=element_blank()) + 
#     facet_grid(. ~ disturbance, labeller = labeller(disturbance = disturb_labels)) +
#     scale_x_continuous(breaks = seq(-0.75, 0.5, 0.5)) +
#     labs(x = "NMDS1", colour = "Season", shape = "Life Stage", y = "NMDS2", title = "Englishman", caption = "stress = 0.133")  + 
#     theme(strip.text.x = element_text(size = 16), plot.caption = element_text(size = 16)) +
#     scale_color_manual(limits = c("summer", "fall", "spring"), labels = c("Summer 2021", "Fall 2021", "Spring 2022"), values = seasoncol) +
#   scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Surface Seed Bank"))
# compare.ra.nmds.ere

## NRE
ds.compare.ra.nre$disturbance = factor(ds.compare.ra.nre$disturbance, levels = c("grubbed", "excl1", "reference"))


compare.ra.nmds.nre = ggplot(ds.compare.ra.nre, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(shape = obs, colour = season))+ 
    theme(axis.text.y = element_text(colour = "black", size = 16), 
    axis.text.x = element_text(colour = "black", size = 16), 
    axis.title.x = element_text(face = "bold", size = 16, colour = "black"), 
    legend.text = element_text(size = 16, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 16), 
    legend.title = element_text(size = 16, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    facet_grid(. ~ disturbance, labeller = labeller(disturbance = disturb_labels)) +
    theme(strip.text.x = element_text(size = 16), plot.caption = element_text(size = 16)) +
    scale_x_continuous(breaks = seq(-0.75, 0.5, 0.5)) +
    labs(x = "NMDS1", colour = "Season", shape = "Life Stage", y = "NMDS2", title = "Nanaimo", caption = "stress = 0.0996")  + 
    scale_color_manual(limits = c("summer", "fall", "spring"), labels = c("Summer 2021", "Fall 2021", "Spring 2022"), values = seasoncol) +
  scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Surface Seed Bank"))
compare.ra.nmds.nre


## LQRE
ds.compare.ra.lqre$disturbance = factor(ds.compare.ra.lqre$disturbance, levels = c("grubbed", "excl10", "reference"))

compare.ra.nmds.lqre = ggplot(ds.compare.ra.lqre, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(shape = obs, colour = season))+ 
    theme(axis.text.y = element_text(colour = "black", size = 16), 
    axis.text.x = element_text(colour = "black", size = 16), 
    axis.title.x = element_text(face = "bold", size = 16, colour = "black"), 
    legend.text = element_text(size = 16, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 16), 
    legend.title = element_text(size = 16, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) +
    facet_grid(. ~ disturbance, labeller = labeller(disturbance = disturb_labels)) +
    labs(x = "NMDS1", colour = "Season", shape = "Life Stage", y = "NMDS2", title = "Little Qualicum", caption = "stress = 0.0703")  + 
    scale_x_continuous(breaks = seq(-0.75, 0.5, 0.5)) +
    theme(strip.text.x = element_text(size = 16), plot.caption = element_text(size = 16)) +
    scale_color_manual(limits = c("summer", "fall", "spring"), labels = c("Summer 2021", "Fall 2021", "Spring 2022"), values = seasoncol) +
  scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Surface Seed Bank"))
compare.ra.nmds.lqre

## panel format w/ ggpubr
compare.ra.nmds.panel <- ggarrange(compare.ra.nmds.nre, compare.ra.nmds.lqre,
          common.legend = TRUE, legend = "bottom",
          ncol = 2, nrow = 1) %>% 
  annotate_figure(bottom = text_grob("Seasonal similarity of species relative abundance in surface seed banks and above-ground vegetation (Euclidean distance)", hjust = 1, x = 1,  size = 14))
compare.ra.nmds.panel

#ggsave("fig-nmds-compare-ra-panel.jpg", compare.ra.nmds.panel, width = 20, height = 6)


```





OLDER - DELETE OR TIDY AS NEEDED

```{r models of standardized responses}

# glm with family = gaussian distribution is the same as lm

####################################################################################
# use estuary as a fixed effect, and bc estuary is not significant, then justifiable as fixed effect (not much difference in terms of graminoid cover)
glm_std_gram <- glm(std_graminoid_cover ~ disturbance + estuary, 
                        #family = "????"
                        data = std)
summary(glm_std_gram)
plot(glm_std_gram)
hist(std$std_graminoid_cover)
####################################################################################

#######
# Graminoids of interest for structural/functional traits
#######

lm_graminoid_cover <- lm(std_graminoid_cover ~ disturbance, 
                        data = std)
summary(lm_graminoid_cover)
plot(lm_graminoid_cover)

#want to include estuary as a random effect, so use lme4. calling glmer() with family=gaussian (identity link) as a shortcut to lmer() is deprecated; please call lmer() directly

lmer_graminoid_cover <- lmer(std_graminoid_cover ~ disturbance + (1|estuary), 
                                data = std)
summary(lmer_graminoid_cover)


# https://towardsdatascience.com/random-effects-in-linear-models-15845b2540ac
std_graminoid_stat = 2*(logLik(lmer_graminoid_cover) - logLik(lm_graminoid_cover,REML = TRUE))

#bootstrap method to simulate the data under the null hypothesis (the simple linear model) and then generate a large number of likelihood ratio test statistics. 
LRT_stdgram_stat = numeric(100)
for(i in 1:100){
  y = simulate(lm_graminoid_cover)$sim_1
  null_stdgram_md = lm(std_graminoid_cover ~ disturbance, 
                        data = std)
  mixed_stdgram_md = lmer(std_graminoid_cover ~ disturbance + (1|estuary), 
                                data = std)
  LRT_stdgram_stat[i] = as.numeric(2*(logLik(mixed_stdgram_md) - logLik(null_stdgram_md,REML = TRUE)))
}

sum(LRT_stdgram_stat > std_graminoid_stat)

# https://stackoverflow.com/questions/60028673/lme4-error-boundary-singular-fit-see-issingular
ranef(lmer_graminoid_cover)
# intercepts are equal, but opposite signs. So, influence of estuary high? 



#######
# Exotic species cover
#######


lm_exotic_cover <- lm(std_exotic_cover ~ disturbance, 
                        data = std)
summary(lm_exotic_cover)
plot(lm_exotic_cover)


lmer_exotic_cover <- lmer(std_exotic_cover ~ disturbance + (1|estuary), 
                                data = std)
summary(lmer_exotic_cover)


# test whether log-likelihood ratio is different from zero
# https://towardsdatascience.com/random-effects-in-linear-models-15845b2540ac
std_exotic_stat = 2*(logLik(lmer_exotic_cover) - logLik(lm_exotic_cover,REML = TRUE))

#bootstrap method to simulate the data under the null hypothesis (the simple linear model) and then generate a large number of likelihood ratio test statistics. https://towardsdatascience.com/random-effects-in-linear-models-15845b2540ac
LRT_std_exotic_stat = numeric(100)
for(i in 1:100){
  y = simulate(lm_exotic_cover)$sim_1
  null_stdexotic_md = lm(std_exotic_cover ~ disturbance, 
                        data = std)
  mixed_stdexotic_md = lmer(std_exotic_cover ~ disturbance + (1|estuary), 
                                data = std)
  LRT_std_exotic_stat[i] = as.numeric(2*(logLik(mixed_stdexotic_md) - logLik(null_stdexotic_md,REML = TRUE)))
}

sum(LRT_std_exotic_stat > std_exotic_stat)
# boundary (singular) fit: see help('isSingular')

# https://stackoverflow.com/questions/60028673/lme4-error-boundary-singular-fit-see-issingular
ranef(lmer_exotic_cover)
# intercept is 0, so effect is very small. OR is it because not enough factor levels in random effect? 


```

```{r veg response models - incomplete attempts}

lm_nonstd_graminoid_cover <- lm(graminoid_cover ~ disturbance, 
                                data = veg.sum)
summary(lm_nonstd_graminoid_cover)
plot(lm_nonstd_graminoid_cover)

####################################################################################
# use estuary as a fixed effect, and bc estuary is not significant, then justifiable as fixed effect (not much difference in terms of graminoid cover)
glm_nonstd_gram <- glm(graminoid_cover ~ disturbance + estuary, 
                        family = "????"
                        data = veg.sum)
summary(glm_nonstd_gram)
plot(glm_nonstd_gram)
####################################################################################



lmer_nonstd_graminoid_cover <- lmer(graminoid_cover ~ disturbance + (1|estuary), 
                                data = veg.sum)
summary(lmer_nonstd_graminoid_cover)

plot(lmer_nonstd_graminoid_cover)

# test whether log-likelihood ratio is different from zero
my_stat = 2*(logLik(lmer_nonstd_graminoid_cover) - logLik(lm_nonstd_graminoid_cover,REML = TRUE))

#bootstrap method to simulate the data under the null hypothesis (the simple linear model) and then generate a large number of likelihood ratio test statistics. https://towardsdatascience.com/random-effects-in-linear-models-15845b2540ac
LRT_stat = numeric(100)
for(i in 1:100){
  y = simulate(lm_nonstd_graminoid_cover)$sim_1
  null_md = lm(graminoid_cover ~ disturbance, 
                                data = veg.sum)
  mixed_md = lmer(graminoid_cover ~ disturbance + (1|estuary), 
                                data = veg.sum)
  LRT_stat[i] = as.numeric(2*(logLik(mixed_md) - logLik(null_md,REML = TRUE)))
}

sum(LRT_stat > my_stat)


# veg_pa <- veg.sum %>%
#   mutate(sedge_pa = ifelse(sedge_prop == 0, 0, 1))

sedge_glm <- glm(sedge_prop ~ disturbance + estuary,
                 family = 'binomial',
                 data = veg.sum) # binomial family appropriate for proportional data constrained 0:1. logit link is default.  

# basics of glms https://www.geo.fu-berlin.de/en/v/soga/Basics-of-statistics/Logistic-Regression/Logistic-Regression-in-R---An-Example/index.html 
summary(sedge_glm)
summary(sedge_glm)$coefficients
plot(sedge_glm)

confint.default(model)[2,]
exp(confint.default(model)[2,])


# https://psyteachr.github.io/msc-data-skills/glm.html
exotic_glm <- glm(exotic_prop ~ disturbance, 
                  data = veg.sum, 
                  family = 'binomial')
summary(exotic_glm) # not a good model bc error for excl1 is wildly incomparable

#res <- residuals(exotic_glm)

```

Vegetation trends

```{r vegetation trends - relative abundance of functional group, means & SE}
veg.abund.mean <- mie.ra %>% 
  group_by(estuary, disturbance, obs, endemic.fngp2) %>%  
  dplyr::summarize(vg.abund = n(),
            vg.abund.mean = mean(rel.abund), 
            vg.abund.sd = sd(rel.abund), 
            vg.abund.se = vg.abund.sd/sqrt(vg.abund)) %>% 
   mutate_all(~replace(., is.na(.), 0)) 
#View(veg.abund.mean)
#View(ra.join)


# unique(veg.abund.mean$endemic.fngp2)
# is.na(veg.abund.mean)
# which(is.na(veg.abund.mean))

#### plot setup

veg.abund.mean$estuary = factor(veg.abund.mean$estuary, levels = c("ere", "nre", "lqre"))
veg.abund.mean$disturbance = factor(veg.abund.mean$disturbance,
                                          levels = c("grubbed", "excl1", "excl10", "reference"),
                                          labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))
veg.abund.mean$endemic.fngp2 = factor(veg.abund.mean$endemic.fngp2,
                                          levels = c("Native Annual forb", "Invasive Annual forb", "Native Perennial forb", "Invasive Perennial forb", "Native Annual graminoid", "Invasive Annual graminoid", "Native Perennial graminoid", "Invasive Perennial graminoid", "NA Unvegetated"),
                                          labels = c("Annual Forb, Native", "Annual Forb, Invasive", "Perennial Forb, Native", "Perennial Forb, Invasive", "Annual Graminoid, Native", "Annual Graminoid, Invasive", "Perennial Graminoid, Native", "Perennial Graminoid, Invasive", "Unvegetated"))

veg.abund.mean$structure = factor(veg.abund.mean$structure, levels = c("short", "med", "tall", "bare"))


pd.abund <- position_dodge(0.4)
abund.col <- c("#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A", "#B2DF8A", "#33A02C", "#B3B3B3") 
#abund.w.seed <- c("#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A", "#FFFF99", "#B15928", "#B2DF8A", "#33A02C", "#B3B3B3")
#brewer.pal(n= 12,"Paired")
# native = light, invasive = dark
# annual forb orange (native) "#FDBF6F" (invasive) "#FF7F00"
# perennial forb purple (native) "#CAB2D6" (invasive) "#6A3D9A" 
# annual graminoid yellow (native) "#FFFF99", (invasive) "#B15928"
#gramoind green (native) "#B2DF8A", (invasive) "#33A02C"
# Unvegetated = "#B3B3B3"


 veg.abund <- veg.abund.mean %>% 
   ggplot(aes(x=disturbance, y=vg.abund.mean, color = endemic.fngp2, shape = obs)) +   
   geom_jitter(size = 7, position = pd.abund) +
   ylim(0, 100)+
   geom_errorbar(aes(ymin = ifelse(vg.abund.mean - vg.abund.se <0, 0, vg.abund.mean - vg.abund.se), 
                     ymax = vg.abund.mean + vg.abund.se), 
                 width = .3, position = pd.abund) +
   labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", color = "Functional Group & \nEndemic Status", shape = "Cover Type") +
   theme_classic()+
   theme(text = element_text(size = 20), 
           panel.spacing.x = unit(1.25, "lines"), 
           axis.text.x = element_text(angle = 25, hjust = 1)) +
   facet_grid(. ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels)) +
   scale_color_manual(values = abund.col) +
   scale_shape_manual(values = c(15, 18), limits = c("veg", "bare"), labels = c("Vegetation", "Unvegetated"))
 
 veg.abund

#ggsave("fig-meanse-veg-abund.jpg", veg.abund, width = 15, height = 6)
```

```{r vegetation trends - relative abundance of clades & structure, means & SE}
 
#View(mie.ra)

veg.structure.mean <- mie.ra %>% 
  #filter(!obs == "bare") %>% 
  group_by(estuary, disturbance, obs, endemic, clade, structure) %>%  
  dplyr::summarize(st.abund = n(),
            st.abund.mean = mean(rel.abund), 
            st.abund.sd = sd(rel.abund), 
            st.abund.se = st.abund.sd/sqrt(st.abund)) %>% 
   mutate_all(~replace(., is.na(.), 0)) %>% 
  ungroup()
#View(veg.structure.mean)

veg.structure.mean$estuary = factor(veg.structure.mean$estuary, levels = c("ere", "nre", "lqre"))
veg.structure.mean$disturbance = factor(veg.structure.mean$disturbance,
                                          levels = c("grubbed", "excl1", "excl10", "reference"),
                                          labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))

veg.structure.mean$structure = factor(veg.structure.mean$structure, levels = c("tall", "med", "short","Unvegetated"), 
                                      labels = c("Tall (> 100 cm)", "Medium (50-100 cm)", "Short (< 50 cm)",  "Unvegetated")) 

veg.structure.mean$clade = factor(veg.structure.mean$clade, levels = c("Forb", "Graminoid", "Unvegetated")) 

pd.structure <- position_dodge(0.5)
structure.col <- c("#00441B", "#41AB5D", "#A1D99B", "#737373")

#brewer.pal(n= 9, "Greens") # "Greens" and "Greys"
# short =  "#A1D99B", medium = "#41AB5D" , tall = "#00441B", unvegetated = "#737373"

  structure.abund <- veg.structure.mean %>% 
   ggplot(aes(x=disturbance, y=st.abund.mean, color = structure, shape = endemic)) +
   geom_jitter(size = 7, position = pd.structure) +
   scale_y_continuous(limits = c(0, 100), breaks = c(0, 50, 100)) +
   geom_errorbar(aes(ymin = ifelse(st.abund.mean - st.abund.se <0, 0, st.abund.mean - st.abund.se),
                     ymax = st.abund.mean + st.abund.se),
                 width = .3, position = pd.structure) +
   labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", color = "Plant Height", shape = "Endemic") +
   theme_classic()+
   theme(text = element_text(size = 18), 
           panel.spacing.x = unit(1.25, "lines"), 
           axis.text.x = element_text(angle = 25, hjust = 1)) +
   facet_grid(clade ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels, clade = clade_labels)) +
    theme(panel.spacing = unit(2, "lines")) +
   scale_color_manual(values = structure.col) +
   scale_shape_manual(values = c(15, 18, 16), limits = c("Native", "Invasive", "Unvegetated"))
 structure.abund

#ggsave("fig-meanse-veg-structure-abund.jpg", structure.abund, width = 15, height = 8)

```

```{r veg NMDS by species relative abund, single plot & facet by estuary}
#colnames(mie.ra)

veg <-  mie.ra %>%
  ungroup() %>% 
  select(-c(obs, endemic, clade, fngp, fngp2, endemic.fngp2, structure, season)) %>% 
  filter(!rel.abund == 0, !species == "bare") %>% 
   group_by(estuary, disturbance) %>% 
  pivot_wider(names_from = species, values_from = rel.abund) %>% 
    mutate_all(~replace(., is.na(.), 0)) 


colnames(veg)
######################
# NMDS based on species presence using Bray's distance
#################################

# matrix of species presence/absence
veg.pa = veg[,4:ncol(veg)]

############################################
#turn abundance data frame into a matrix
############################################
veg.matrix = as.matrix(veg.pa)

############################################
# Stress
############################################
#all
set.seed(123)
nmds.veg = metaMDS(veg.matrix, distance = "bray")
nmds.veg
# stress = 0.174

############################################
#extract NMDS scores (x and y coordinates)
############################################
ds.veg = as.data.frame(scores(nmds.veg))
#View(ds.veg)
#any(is.na(ds.veg))

############################################
#add columns to data frame 
############################################
ds.veg$id = veg$id

ds.veg$disturbance = veg$disturbance

ds.veg$estuary = veg$estuary

############################################
# PLOT
############################################

## all
ds.veg$estuary = factor(ds.veg$estuary, levels = c("ere", "nre", "lqre"))
ds.veg$disturbance <- as.factor(ds.veg$disturbance)

veg.nmds = ggplot(ds.veg, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance, shape = estuary)) + 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", shape = "Estuary", y = "NMDS2", caption = "Above-ground species relative abundance (Bray's distance), stress = 0.174")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
    scale_colour_brewer(palette = "PRGn", limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
    scale_shape_discrete(limits = c("ere", "nre", "lqre"), labels = c("Englishman", "Nanaimo", "Little Qualicum"))
veg.nmds

#ggsave("fig-nmds-veg.jpg", veg.nmds, width = 15, height = 6)


# # Single NMDS, faceted by estuary. See Fig. 3 in June 2022 outline v1.2 (choosing which figure representation is best)
facet.veg.nmds = ggplot(ds.veg, aes(x = NMDS1, y = NMDS2)) +
    geom_point(size = 6, aes(colour = disturbance))+
    theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"),
    axis.text.x = element_text(colour = "black", face = "bold", size = 14),
    legend.text = element_text(size = 14, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"),
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"),
    legend.title = element_text(size = 14, colour = "black", face = "bold"),
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) +
    facet_grid(. ~ estuary, labeller = labeller(estuary = facet_labels)) +
    labs(x = "NMDS1", colour = "Disturbance", shape = "Estuary", y = "NMDS2", caption = "above-ground species presence/absence (Bray's distance), stress = 0.174 between all estuaries, faceted by estuary for visual distinction")  +
    theme(strip.text.x = element_text(size = 14, face = "bold")) +
    scale_colour_brewer(palette = "PRGn", limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
    scale_shape_discrete(limits = c("ere", "nre", "lqre"), labels = c("Englishman", "Nanaimo", "Little Qualicum"))
facet.veg.nmds




```

```{r veg NMDS by species cover, run separately by estuary}


veg.ere <- veg %>% filter(estuary == "ere")

veg.nre <- veg %>% filter(estuary == "nre")

veg.lqre <- veg %>% filter(estuary == "lqre")

######################
# NMDS 
#################################

# matrix of species 
veg.pa.ere = veg.ere[,4:ncol(veg.ere)]
veg.pa.nre = veg.nre[,4:ncol(veg.nre)]
veg.pa.lqre = veg.lqre[,4:ncol(veg.lqre)]

############################################
#turn data frame into a matrix
############################################
veg.matrix.ere = as.matrix(veg.pa.ere)
veg.matrix.nre = as.matrix(veg.pa.nre)
veg.matrix.lqre = as.matrix(veg.pa.lqre)

############################################
# Stress
############################################

#ERE
set.seed(123)
nmds.veg.ere = metaMDS(veg.matrix.ere, distance = "bray")
nmds.veg.ere
#stress = 0.099

# NRE
set.seed(123)
nmds.veg.nre = metaMDS(veg.matrix.nre, distance = "bray")
nmds.veg.nre
# stress = 0.120

# LQRE
set.seed(123)
nmds.veg.lqre = metaMDS(veg.matrix.lqre, distance = "bray")
nmds.veg.lqre
# stress = 0.095

############################################
#extract NMDS scores (x and y coordinates)
############################################
ds.veg.ere = as.data.frame(scores(nmds.veg.ere))
ds.veg.nre = as.data.frame(scores(nmds.veg.nre))
ds.veg.lqre = as.data.frame(scores(nmds.veg.lqre))

############################################
#add columns to data frame 
############################################
ds.veg.ere$id = veg.ere$id
ds.veg.nre$id = veg.nre$id
ds.veg.lqre$id = veg.lqre$id

ds.veg.ere$disturbance = veg.ere$disturbance
ds.veg.nre$disturbance = veg.nre$disturbance
ds.veg.lqre$disturbance = veg.lqre$disturbance

ds.veg.ere$estuary = veg.ere$estuary
ds.veg.nre$estuary = veg.nre$estuary
ds.veg.lqre$estuary = veg.lqre$estuary

############################################
# PLOT
############################################


## ERE
ds.veg.ere$disturbance <- as.factor(ds.veg.ere$disturbance)
#brewer.pal(n=11,"PRGn")

veg.nmds.ere = ggplot(ds.veg.ere, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance))+ 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", y = "NMDS2", title = "Englishman", caption = "stress = 0.099")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
     scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837"))
veg.nmds.ere


## NRE
ds.veg.nre$disturbance <- as.factor(ds.veg.nre$disturbance)

veg.nmds.nre = ggplot(ds.veg.nre, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance))+ 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", y = "NMDS2", title = "Nanaimo", caption = "stress = 0.120")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
    scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837"))
veg.nmds.nre

## LQRE
ds.veg.lqre$disturbance <- as.factor(ds.veg.lqre$disturbance)

veg.nmds.lqre = ggplot(ds.veg.lqre, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance))+ 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", y = "NMDS2", title = "Little Qualicum", caption = "stress = 0.095")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
     scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837"))
veg.nmds.lqre

veg.nmds.ere
veg.nmds.nre
veg.nmds.lqre



## panel format w/ ggpubr
veg.panel <- ggarrange(veg.nmds.ere, veg.nmds.nre, veg.nmds.lqre,  # + rremove("x.text")
          common.legend = TRUE, legend = "bottom",
          ncol = 3, nrow = 1) %>% 
  annotate_figure(bottom = text_grob("Above-ground vegetation species cover abundance (Bray's distance)", hjust = 1, x = 1,  size = 20))
veg.panel

#ggsave("fig-nmds-veg-panel.jpg", veg.panel, width = 15, height = 6)

```

```{r veg relabund PERMANOVA}

#View(ra.join)
# tutorials: 
# https://raunakms.github.io/diversity_cooking_fuel/06_01_permanova_test.html
# https://github.com/pmartinezarbizu/pairwiseAdonis/blob/master/pairwiseAdonis/R/pairwise.adonis.R, from advice in https://www.researchgate.net/post/Posthoc_test_for_permanova_adonis



# PERMANOVA
sp.compare.ra = compare.ra[,8:ncol(compare.ra)]
comp.ra.matrix <- vegdist(sp.compare.ra, method = 'bray')

# is.na(comp.matrix)
# which(is.na(comp.matrix))

set.seed(42)
permanova.compare.ra <- adonis2(comp.ra.matrix ~ disturbance + estuary + obs + season + structure, data = compare.ra, permutations = 99, method = "bray")
permanova.compare.ra


permtst.struc <- RVAideMemoire::pairwise.perm.manova(resp = comp.ra.matrix, fact = compare.ra$structure, 
    test = "Pillai", nperm = 999, progress = TRUE, p.method = "none")
df.structure <- reshape2::melt(permtst.struc$p.value)
colnames(df.structure) <- c("structure1", "structure2", "pvalue")
df.structure <- df.structure[-which(is.na(df.structure$pvalue)), ]
df.structure$pvalue.adj <- p.adjust(p = df.structure$pvalue, method = "bonferroni", n = length(df.structure$pvalue))

kable(df.structure)


permtst.disturb <- RVAideMemoire::pairwise.perm.manova(resp = comp.ra.matrix, fact = compare.ra$disturbance, 
    test = "Pillai", nperm = 999, progress = TRUE, p.method = "none")
df.disturb <- reshape2::melt(permtst.disturb$p.value)
colnames(df.disturb) <- c("disturb1", "disturb2", "pvalue")
df.disturb <- df.disturb[-which(is.na(df.disturb$pvalue)), ]
df.disturb$pvalue.adj <- p.adjust(p = df.disturb$pvalue, method = "bonferroni", n = length(df.disturb$pvalue))

kable(df.disturb)



# kable(df.disturb,
#    col.names = c("Disturbance 1", "Disturbance 2", "p-value", "p-value (Bonferroni)"),
#    align = "c",  digits = 3) %>% #booktabs = TRUE,
#    #row_spec(1:6, color = 'black') %>%
#    kable_styling(font_size = 16, latex_options = "scale_down") %>%
#     save_kable("permanova-pairwise-disturb.jpeg")

```

```{r lm of rel.abund}
# linear model (multiple regression, see Winter 2013), treating all variables as fixed effects


ra.model <- ra.join %>% 
  ungroup() %>% 
  filter(!obs == "bare") %>% 
  select(-sum.seed, -endemic.fngp2) %>% 
  replace(is.na(.), 0) 
#View(ra.model)

# http://www.sthda.com/english/articles/40-regression-analysis/163-regression-with-categorical-variables-dummy-coding-essentials-in-r/#categorical-variables-with-more-than-two-levels
library(car)
model <- lm(rel.abund ~ disturbance + obs + structure + estuary  + season , data = ra.model) #  (*) is interaction whereas (+) is additive effect
Anova(model)
summary(model)

# https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/predict.lm
pred.lm <- predict(model, ra.model, se.fit = FALSE, scale = NULL, df = Inf,
        interval = c("confidence"),
        level = 0.95, type = c("response"),
        terms = NULL, na.action = na.pass)

pred.lm <- as.data.frame(pred.lm) 

pred.val <- cbind(pred.lm, ra.model)
View(pred.val)

hist(ra.model$rel.abund)
plot(model)

####### 
# Plot
#######

pred.val$disturbance <- factor(pred.val$disturbance , levels = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))
ra.model$disturbance <- factor(ra.model$disturbance , levels = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))



pred.val$structure <- factor(pred.val$structure , levels = c("short", "med", "tall"), labels = c("Short (< 50 cm)", "Medium (50-100 cm)", "Tall (> 100 cm)"))
ra.model$structure <- factor(ra.model$structure , levels = c("short", "med", "tall"), labels = c("Short (< 50 cm)", "Medium (50-100 cm)", "Tall (> 100 cm)"))


pred.val$obs <- factor(pred.val$obs , levels = c("veg", "seed"), labels = c("Above-Ground \nVegetation", "Surface Seed Bank"))
ra.model$obs <- factor(ra.model$obs , levels = c("veg", "seed"), labels = c("Above-Ground \nVegetation", "Surface Seed Bank"))



#https://sejohnston.com/2012/08/09/a-quick-and-easy-function-to-plot-lm-results-in-r/
ggplotRegression <- function (fit) {
require(ggplot2)
ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) +
  geom_point() +
  geom_pointrange(data = pred.val , aes(x = disturbance, y = fit, ymin = lwr, ymax = upr), size = 0.8, colour = "blue") +
  ylab("Relative abundance\nof species observed") +
  xlab("Disturbance") +
  theme_classic(base_size = 12)+
  theme(panel.spacing.x = unit(1.25, "lines"),
        axis.text.x = element_text(angle = 25, hjust = 1)) + # text = element_text(size = 16)
  facet_grid(obs~structure) +
  theme(panel.spacing = unit(2, "lines")) #+
  #stat_smooth(method = "lm", col = "red") # +
  #labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                    # "Intercept =",signif(fit$coef[[1]],5 ),
                    # " Slope =",signif(fit$coef[[2]], 5),
                    # " P =",signif(summary(fit)$coef[2,4], 5)))
}

ggplotRegression(lm(rel.abund ~ disturbance + estuary + obs + season + structure, data = ra.model))






```

```{r use betareg for beta distribution}
# cannot use lm or mixed effect bc skewed distribution
# beta distribution assumes dist between 0 to 1 (*transform data; but cannot have 0, must have 0.000000000001; same for 1)

library(betareg)
library(emmeans)
library(multcompView)
library(multcomp)
library(sjPlot) #for plotting lmer and glmer mods


ra.model.beta <- ra.join %>% 
  ungroup() %>% 
  filter(!obs == "bare") %>% 
  dplyr::select(-sum.seed, -endemic.fngp2) %>% 
  replace(is.na(.), 0) %>% 
  mutate(prop.abund = rel.abund/100) %>%
  relocate(prop.abund, .after = rel.abund) %>% 
  mutate(prop.abund = case_when(prop.abund == 1 ~ 0.9999999,
                                prop.abund == 0 ~ 0.0000001, 
                                TRUE ~ prop.abund))

# View(ra.model.beta)
# min(ra.model.beta$prop.abund)
# max(ra.model.beta$prop.abund)


beta.model <- betareg(prop.abund ~ disturbance + obs + structure + estuary  + season , data = ra.model.beta) #  (*) is interaction whereas (+) is additive effect

joint_tests(beta.model)

Anova(beta.model)
summary(beta.model)

hist(ra.model.beta$prop.abund)
plot(fitted(beta.model), residuals(beta.model))

# plot effect sizes
sjPlot::plot_model(beta.model)

sjPlot:: tab_model(beta.model)

## Get predicted values 
## USE EMMEANS


# pred <- predict(beta.model, ra.model.beta, # se.fit = FALSE, scale = NULL, df = Inf,
#         interval = c("confidence"),
#         level = 0.95, type = c("response"),
#         terms = NULL, na.action = na.pass)
#head(pred)

# pred.df <- as.data.frame(pred) 
# pred.val.beta <- cbind(pred.df, ra.model.beta)

beta.emm <- emmeans(beta.model, c("disturbance", "obs", "structure"), type = "response")
beta.emm <- as.data.frame(beta.emm)


####### 
# Plot
#######

beta.emm$disturbance <- factor(beta.emm$disturbance , levels = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))
ra.model.beta$disturbance <- factor(ra.model.beta$disturbance , levels = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))



beta.emm$structure <- factor(beta.emm$structure , levels = c("short", "med", "tall"), labels = c("Short (< 50 cm)", "Medium (50-100 cm)", "Tall (> 100 cm)"))
ra.model.beta$structure <- factor(ra.model.beta$structure , levels = c("short", "med", "tall"), labels = c("Short (< 50 cm)", "Medium (50-100 cm)", "Tall (> 100 cm)"))


beta.emm$obs <- factor(beta.emm$obs , levels = c("veg", "seed"), labels = c("Above-Ground \nVegetation", "Surface Seed Bank"))
ra.model.beta$obs <- factor(ra.model.beta$obs , levels = c("veg", "seed"), labels = c("Above-Ground \nVegetation", "Surface Seed Bank"))



ggplot(ra.model.beta, aes(x = disturbance, y = prop.abund))+
  geom_point() +
  geom_pointrange(data = beta.emm , aes(x = disturbance, y = emmean, ymin = asymp.LCL, ymax = asymp.UCL), size = 0.8, colour = "blue") +
  ylab("Relative abundance\nof species observed (proportion)") +
  xlab("Disturbance") +
  theme_classic(base_size = 16)+
  theme(panel.spacing.x = unit(1.25, "lines"),
        axis.text.x = element_text(angle = 25, hjust = 1)) + # text = element_text(size = 16)
  facet_grid(obs~structure) +
  theme(panel.spacing = unit(2, "lines"))






```

```{r glm of rel.abund}
# https://lmudge13.github.io/sample_code/mixed_effects.html

# note: random effects must have at leas 5 levels (https://ourcodingclub.github.io/tutorials/mixed-models/#three), so should not treat estuary/obs/season/structure as random effects. 

# uses ra.model from preceding code
#View(ra.model)


library(tidyverse) #for all data wrangling
library(cowplot) #for manuscript ready figures
library(lme4) #for lmer & glmer models
library(sjPlot) #for plotting lmer and glmer mods
library(sjmisc) 
library(effects)
library(sjstats) #use for r2 functions

#use the lme4 package

mod <- lme4::lmer(rel.abund ~ disturbance + obs + estuary + season + structure + (1|id), REML= FALSE, data= ra.model) #  

summary(mod)

# plot effect sizes
sjPlot::plot_model(mod)

sjPlot:: tab_model(mod)

# check assumptions

plot(mod)
qqnorm(resid(mod))
qqline(resid(mod))

## Plot model w/ data

# Step 1: Save the effect size estimates into a data.frame

# Use the effects package --> effect function. term= the fixed effect you want to get data on, mod= name of your model.

effects_disturb <- effects::effect(term= "disturbance", mod= mod)
summary(effects_disturb) #output of what the values are

# Save the effects values as a df:
x_disturb <- as.data.frame(effects_disturb)


# Step 2: Use the effects value df (created above) to plot the estimates

#Basic steps:
  #1 Create empty plot
  #2 Add geom_points() from the DATA: urchin data on the x axis (independent va= disturbance) and coral data on the y-axis (response var= rel.abund)
  #3 Add geom_point for the MODEL estimates (data= x_disturb)
  #4 Add geom_line for the MODEL estimates. Change the color to match the estimate points (ie whatever color you chose for step3)
  #5 Add geom_ribbon that has the CI limits for the model estimates
  #6 Edit the labels as you see fit!

x_disturb$disturbance <- factor(x_disturb$disturbance , levels = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))

ra.model$disturbance <- factor(ra.model$disturbance , levels = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))

ra.model$structure <- factor(ra.model$structure , levels = c("short", "med", "tall"), labels = c("Short (< 50 cm)", "Medium (50-100 cm)", "Tall (> 100 cm)"))

ra.model$obs <- factor(ra.model$obs , levels = c("veg", "seed"), labels = c("Above-Ground \nVegetation", "Surface Seed Bank"))



disturb_plot <- ggplot() + 
  geom_point(data=ra.model, aes(disturbance, rel.abund, group = 1)) + 
  geom_point(data=x_disturb, aes(x=disturbance, y=fit), color="blue") + 
  geom_line(data=x_disturb, aes(x=disturbance, y=fit), color="blue") +
  geom_ribbon(data= x_disturb, aes(x=disturbance, ymin=lower, ymax=upper), alpha= 0.3, fill="blue") +
  labs(x="Grazing Disturbance", y="Relative Abundance") +
  facet_grid(obs~structure) +
  theme(panel.spacing = unit(2, "lines")) 
disturb_plot


```



I wanted to know:
(1)	Whether surface seed banks in heavily grazed or grubbed sites resemble their above-ground vegetation counterparts, or if they retain compositional diversity similar to ungrazed sites. 
a.	Because intensive grazing and grubbing removes vegetation structural complexity and leads to increased erosion, I do not expect surface seed banks in recently grubbed or heavily grazed sites to be compositionally similar to undisturbed seed banks. 

(2)	If surface seed banks and vegetation exhibit resilience by returning to a ‘reference’ condition when grazing has been excluded for 10 years. 
a.	I expect sites recovered for 10 years to have similar species compositional abundance to undisturbed sites due to clonal expansion from surrounding marsh vegetation. This will support greater vegetation structural complexity, which will trap seeds produced within or dispersed into the patch.   

(3)	Whether seasonal surface seed bank compositional changes are affected by grazing impacts. 
a.	I expect seed banks at recently grubbed or heavily grazed sties will be highly variable between seasons due to increased opportunities for erosion or seed dispersal within/between sites because these sites have less vegetation structural complexity to trap seeds locally. 
 
 
 
 

```{r impact to PFGs}

mie$fngp <- factor(mie$fngp , levels = c("Annual forb", "Annual graminoid, fibrous roots", "Perennial forb, fibrous roots", "Perennial forb, rhizomatous roots",  "Perennial graminoid, fibrous roots", "Perennial graminoid, rhizomatous roots"))

# 
# ggplot(mie, aes(fill=fngp, y=cover, x=disturbance)) + 
#     geom_bar(position="fill", stat="identity") +
#     theme_classic()+
#     facet_grid(~estuary, scales = "free", space = "free") + 
#     theme(text = element_text(size = 20), 
#           panel.spacing.x = unit(1.25, "lines"), 
#           axis.text.x = element_text(angle = 45, hjust = 1)) +
#     labs(y="Relative Abundance 
#          (% cover)", x="Disturbance condition", fill = "Plant Functional Group") +
#     scale_fill_brewer(palette = "Spectral")  


#View(veg_end)
veg_end <- mie %>% select(estuary, disturbance,endemic, fngp, cover) %>% 
  group_by(disturbance, endemic, estuary) %>% 
  mutate(relabund = cover/100) %>% 
  filter(!relabund == 0) %>% 
  group_by(estuary, disturbance, endemic) %>% 
  dplyr::summarize(veg_end.n = n(),
            veg_end.mean = mean(relabund), 
           veg_end.sd = sd(relabund), 
            veg_end.se = veg_end.sd/sqrt(veg_end.n))
 
pd <- position_dodge(0.65)

View(veg_end)
unique(veg_end$disturbance)


veg_end %>%  
  ggplot(aes(x=disturbance, y=veg_end.mean, color = endemic, shape = estuary)) +   
  geom_jitter(position = pd, 
             size = 7) +
  geom_errorbar(aes(ymin = ifelse(veg_end.mean - veg_end.se <0, 0, veg_end.mean - veg_end.se), 
                    ymax = veg_end.mean + veg_end.se),
                width = .3, 
                position = pd) + 
  labs(x = "Disturbance condition", y = " Mean Relative Cover Abundance", color = "Endemism", shape = "Estuary", caption = "points are means, bars are SE") +
  theme_classic()+
  scale_y_continuous(limits=c(0,1), breaks=c(0,0.5,1)) +
  theme(text = element_text(size = 20), 
          panel.spacing.x = unit(1.25, "lines"), 
          axis.text.x = element_text(angle = 25, hjust = 1)) +
  scale_x_discrete(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
   scale_shape_discrete(limits = c("ere", "nre", "lqre"), labels = c("Englishman", "Nanaimo", "Little Qualicum")) +
  scale_color_brewer(limits = c("Native", "Invasive"), labels = c("Native", "Invasive"), palette = "Set2")

```

```{r LM - PFG response over time}

# response = cover, by functional group
# explanatory = disturbance (categorical, fixed), estuary (categorical, random), elevation (continuous, random), salinity (continuous, random)
# 

veg.abund <- mie %>% select(estuary, disturbance, elev, sal, fngp, fngp2, cover) %>% 
  group_by(disturbance, fngp2, estuary) %>% 
  mutate(relabund = cover/100)  %>% 
  filter(!relabund == 0) %>% 
  group_by(estuary, disturbance, fngp2)

lm <- veg.abund %>% 
  dplyr::summarize(veg.fngp.n = n(),
            veg.fngp.mean = mean(relabund), 
           veg.fngp.sd = sd(relabund), 
            veg.fngp.se = veg.fngp.sd/sqrt(veg.fngp.n))

# https://faculty.nps.edu/rbassett/_book/multiple-regression-models.html#multiple-regression-with-categorical-variables-including-the-neighborhood
mlm <- lm(relabund ~ disturbance + estuary + fngp2, data = veg.abund)
summary(mlm)
# * NOTE: check assumptions https://faculty.nps.edu/rbassett/_book/introduction-to-linear-regression.html#assumptions-of-linear-regression 


# plot relative abundance (> 0) of graminoids  
pd <- position_dodge(0.65)
lm %>%  
  ggplot(aes(x=disturbance, y=veg.fngp.mean, color = fngp2, shape = estuary)) +   
  geom_jitter(position = pd, 
             size = 7) +
  geom_errorbar(aes(ymin = veg.fngp.mean - veg.fngp.se, 
                    ymax = veg.fngp.mean + veg.fngp.se),
                width = .2, 
                position = pd) + 
  labs(x = "Disturbance condition", y = "Relative Cover Abundance", color = "Plant Functional Group", shape = "Estuary") +
  theme_classic()+
   theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"), 
    axis.text.x = element_text(colour = "black", size = 14, angle = 25, hjust = 1), 
    legend.text = element_text(size = 14, colour ="black", lineheight = 1), legend.key.height = unit(1.15, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
  scale_x_discrete(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
  scale_y_continuous(limits=c(0,1), breaks=c(0, 0.25, 0.5, 0.75, 1)) +
  scale_shape_discrete(limits = c("ere", "nre", "lqre"), labels = c("Englishman", "Nanaimo", "Little Qualicum")) +
  scale_color_manual(values = pfgcol)
# rn, can't draw regression lines bc explanatory variable is categorical (needs to be factor or integer)

### GLMSs https://faculty.nps.edu/rbassett/_book/logistic-regression.html#glm-generalized-linear-models 


```

```{r simplified PFGs native/invasive by estuary}

pfg2.abund <- mie %>% select(estuary, disturbance, endemic, elev, sal, fngp2, cover) %>% 
  group_by(estuary, disturbance, fngp2, endemic) %>% 
  mutate(relabund = cover/100)  %>% 
  filter(!relabund == 0, !endemic == "NA") %>% 
  group_by(estuary, disturbance, fngp2, endemic)


# filter by estuary
pfg2.ere <- pfg2.abund %>% filter(estuary == "ere")
pfg2.nre <- pfg2.abund %>% filter(estuary == "nre")
pfg2.lqre <- pfg2.abund %>% filter(estuary == "lqre")

#summarize mean & SE
pfg.abund.ere <- pfg2.ere %>% 
  dplyr::summarize(veg.fngp2.n = n(),
            veg.fngp2.mean = mean(relabund), 
           veg.fngp2.sd = sd(relabund), 
            veg.fngp2.se = veg.fngp2.sd/sqrt(veg.fngp2.n)) %>% 
    mutate_all(~replace(., is.na(.), 0)) 


pfg.abund.nre <- pfg2.nre %>% 
  dplyr::summarize(veg.fngp2.n = n(),
            veg.fngp2.mean = mean(relabund), 
           veg.fngp2.sd = sd(relabund), 
            veg.fngp2.se = veg.fngp2.sd/sqrt(veg.fngp2.n)) %>% 
    mutate_all(~replace(., is.na(.), 0)) 

pfg.abund.lqre <- pfg2.lqre %>% 
  dplyr::summarize(veg.fngp2.n = n(),
            veg.fngp2.mean = mean(relabund), 
           veg.fngp2.sd = sd(relabund), 
            veg.fngp2.se = veg.fngp2.sd/sqrt(veg.fngp2.n)) %>% 
    mutate_all(~replace(., is.na(.), 0)) 





######################################
# PLOT
######################################

#brewer.pal(n=3,"Dark2")
pfg2col <- c("#D95F02", "#7570B3", "#1B9E77")
pd.pfg2 <- position_dodge(0.4)

## ERE
meanse.pfg2.ere <- pfg.abund.ere %>%  
  ggplot(aes(x=disturbance, y=veg.fngp2.mean, shape = fngp2, color = endemic)) +   
  geom_jitter(position = pd.pfg2, 
             size = 7) +
  geom_errorbar(aes(ymin = ifelse(veg.fngp2.mean - veg.fngp2.se <0,0, veg.fngp2.mean - veg.fngp2.se), 
                    ymax = veg.fngp2.mean + veg.fngp2.se),
                width = .3, 
                position = pd.pfg2) + 
  labs(x = "", y = "Mean Relative Abundance \nAbove-Ground Cover", color = "Endemism", shape = "Plant Functional Group") +
  theme_classic()+
   theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"), 
    axis.text.x = element_text(colour = "black", size = 14, angle = 25, hjust = 1), 
    legend.text = element_text(size = 14, colour ="black", lineheight = 1), legend.key.height = unit(1.15, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
  labs(title = "Englishman") +
  scale_x_discrete(limits = c("grubbed", "reference"), labels = c("Grubbed", "Undisturbed")) +
  scale_y_continuous(limits=c(0,1), breaks=c(0, 0.25, 0.5, 0.75, 1)) +
  scale_shape_discrete(limits = c("Annual", "Perennial graminoid", "Perennial forb"), labels = c("Annual", "Perennial Graminoid", "Perennial Forb")) +
  scale_color_manual(limits = c("Native", "Invasive"), labels = c("Native", "Invasive"), values = c("#01665E", "#BF812D"))
meanse.pfg2.ere

## NRE
meanse.pfg2.nre <- pfg.abund.nre %>%  
  ggplot(aes(x=disturbance, y=veg.fngp2.mean, shape = fngp2, color = endemic)) +   
  geom_jitter(position = pd.pfg2, 
             size = 7) +
  geom_errorbar(aes(ymin = ifelse(veg.fngp2.mean - veg.fngp2.se <0,0, veg.fngp2.mean - veg.fngp2.se),
                    ymax = veg.fngp2.mean + veg.fngp2.se),
                width = .3, 
                position = pd.pfg2) + 
  labs(x = "Disturbance Condition", y = "", color = "Endemism", shape = "Plant Functional Group") +
  theme_classic()+
   theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"), 
    axis.text.x = element_text(colour = "black", size = 14, angle = 25, hjust = 1), 
    legend.text = element_text(size = 14, colour ="black", lineheight = 1), legend.key.height = unit(1.15, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
  labs(title = "Nanaimo") +
  scale_x_discrete(limits = c("grubbed", "excl1", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Undisturbed")) +
  scale_y_continuous(limits=c(0,1), breaks=c(0, 0.25, 0.5, 0.75, 1)) +
   scale_shape_discrete(limits = c("Annual", "Perennial graminoid", "Perennial forb"), labels = c("Annual", "Perennial Graminoid", "Perennial Forb")) +
  scale_color_manual(limits = c("Native", "Invasive"), labels = c("Native", "Invasive"), values = c("#01665E", "#BF812D"))
meanse.pfg2.nre

## LQRE
meanse.pfg2.lqre <- pfg.abund.lqre %>%  
  ggplot(aes(x=disturbance, y=veg.fngp2.mean, shape = fngp2, color = endemic)) +   
  geom_jitter(position = pd.pfg2, size = 7) +
  geom_errorbar(aes(ymin = ifelse(veg.fngp2.mean - veg.fngp2.se <0,0, veg.fngp2.mean - veg.fngp2.se),
                    ymax = ifelse(veg.fngp2.mean + veg.fngp2.se >1,1, veg.fngp2.mean + veg.fngp2.se)),
                width = .3, 
                position = pd.pfg2) + 
  labs(x = "", y = "", color = "Endemism", shape = "Plant Functional Group") +
  theme_classic()+
   theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"), 
    axis.text.x = element_text(colour = "black", size = 14, angle = 25, hjust = 1), 
    legend.text = element_text(size = 14, colour ="black", lineheight = 1), legend.key.height = unit(1.15, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
  labs(title = "Little Qualicum") +
  scale_x_discrete(limits = c("grubbed", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
  scale_y_continuous(limits=c(0,1), breaks=c(0, 0.25, 0.5, 0.75, 1)) +
  scale_shape_discrete(limits = c("Annual", "Perennial graminoid", "Perennial forb"), labels = c("Annual", "Perennial Graminoid", "Perennial Forb")) +
  scale_color_manual(limits = c("Native", "Invasive"), labels = c("Native", "Invasive"), values = c("#01665E", "#BF812D"))
meanse.pfg2.lqre


## panel format w/ ggpubr
pfg2.panel <- ggarrange(meanse.pfg2.ere, meanse.pfg2.nre, meanse.pfg2.lqre,
          common.legend = TRUE, legend = "bottom",
          ncol = 3, nrow = 1, 
          heights = c(1, 1, 1)) #%>% 
  #annotate_figure(left = text_grob("Mean Relative Cover Abundance", size = 20, rot = 90))
pfg2.panel

#ggsave("fig-pfg2-panel.jpg", pfg2.panel, width = 15, height = 6)

```

```{r seed bank richness/abundance}

seed.end.mean <- seed %>% 
  group_by(estuary, disturbance, endemic) %>% 
  dplyr::summarize(seed.end.n = n(),
            seed.end.mean = mean(ct), 
            seed.end.sd = sd(ct), 
            seed.end.se = seed.end.sd/sqrt(seed.end.n))
 
pd.seed <- position_dodge(0.15)


seed.end.mean %>%  
  ggplot(aes(x=disturbance, y=seed.end.mean, color = endemic, shape = estuary)) +   
  geom_point(position = pd.seed, size = 7) +
  geom_errorbar(aes(ymin = seed.end.mean - seed.end.se, 
                    ymax = seed.end.mean + seed.end.se),
                width = .1, 
                position = pd.seed) + 
  labs(x = "Disturbance condition", y = expression(Seed~Abundance~(per~0.015~m^2)), color = "Endemism", shape = "Estuary") +
  theme_classic()+
  theme(text = element_text(size = 20), 
          panel.spacing.x = unit(1.25, "lines"), 
          axis.text.x = element_text(angle = 25, hjust = 1)) +
  scale_x_discrete(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
   scale_shape_discrete(limits = c("ere", "nre", "lqre"), labels = c("Englishman", "Nanaimo", "Little Qualicum")) +
  scale_color_brewer(limits = c("Native", "Invasive"), labels = c("Native", "Invasive") ,palette = "Set2")

###############################################
# Abundance by functional group
###############################################


fngp.mean <- seed %>% 
  group_by(estuary, disturbance, fngp) %>% 
  dplyr::summarize(n.fngp = n(),
            mean.fngp = mean(ct), 
            sd.fngp = sd(ct), 
            se.fngp = sd.fngp/sqrt(n.fngp))

fngp.mean %>%  
  ggplot(aes(x=disturbance, y=mean.fngp, color = fngp, shape = estuary)) +   
  geom_point(position = pd.seed, 
             size = 7) +
  geom_errorbar(aes(ymin = mean.fngp - se.fngp, 
                    ymax = mean.fngp + se.fngp),
                width = .1, 
                position = pd.seed) + 
  labs(x = "Disturbance condition", y = expression(Seed~Abundance~(per~0.015~m^2)), color = "Functional Group", shape = "Estuary") +
  theme_classic()+
  theme(text = element_text(size = 18), 
          panel.spacing.x = unit(1.25, "lines"), 
          axis.text.x = element_text(angle = 25, hjust = 1)) +
  scale_x_discrete(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
   scale_shape_discrete(limits = c("ere", "nre", "lqre"), labels = c("Englishman", "Nanaimo", "Little Qualicum")) +
  scale_color_manual(values = pfgcol)

```

```{r richness, seed & veg}


############################################
# Sp richness by age since disturbance
############################################

seed.rich <- seed %>% 
   group_by(estuary, disturbance, id) %>% 
   dplyr::summarize(n.rich = n_distinct(species)) %>% 
  mutate(obs = "seed") 


mie.rich <- mie %>%
  select(-c(site, sal, elev, endemic, life, root, clade, fngp)) %>% 
  filter(!cover == 0, !species == "bare") %>% 
   group_by(estuary, disturbance, id) %>% 
   dplyr::summarize(n.rich = n_distinct(species)) %>% 
  mutate(obs = "veg")

mie.rich$id <- as.character(mie.rich$id)
sp.rich <- seed.rich %>% full_join(mie.rich, by = c("estuary", "disturbance", "id", "n.rich", "obs")) 


sp.rich.mean <- sp.rich %>% 
  group_by(estuary, disturbance, obs) %>% 
  dplyr::summarize(sp.rich = n(),
            sp.rich.mean = mean(n.rich), 
            sp.rich.sd = sd(n.rich), 
            sp.rich.se = sp.rich.sd/sqrt(sp.rich))

pd.rich <- position_dodge(0.15)

sp.rich.mean %>%  
  ggplot(aes(x=disturbance, y=sp.rich.mean, color = obs, shape = estuary)) +   
  geom_point(size = 7, position = pd.seed) +
  geom_errorbar(aes(ymin = sp.rich.mean - sp.rich.se, 
                    ymax = sp.rich.mean + sp.rich.se),
                width = .1, 
                position = pd.rich) + 
  labs(x = "Disturbance condition", y = "Mean Species Richness", color = "Species Richness Source", shape = "Estuary") +
  theme_classic()+
  theme(text = element_text(size = 20), 
          panel.spacing.x = unit(1.25, "lines"), 
          axis.text.x = element_text(angle = 25, hjust = 1)) +
  scale_x_discrete(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
  scale_shape_discrete(limits = c("ere", "lqre", "nre"), labels = c("Englishman", "Little Qualicum", "Nanaimo")) +
  scale_color_manual(limits = c("veg", "seed"), labels = c("Above-Ground Vegetation", "Seed Bank"), values = c("#01665E", "#BF812D"))


#brewer.pal(n=10,"BrBG")

#seed = brown "#BF812D"
#veg = teal "#01665E"

# NRE = blue "#1F78B4"
# LQRE = red "#E31A1C" 
# ERE = yellow "#FFD92F"


####################################### 
# sp richness by exotic status
#######################################

seed.rich.endemic <- seed %>% 
   group_by(estuary, disturbance, id, endemic) %>% 
   dplyr::summarize(n.rich.end = n_distinct(species)) %>% 
  mutate(obs = "seed") 


mie.rich.endemic <- mie %>%
  select(-c(site, sal, elev, life, root, clade, fngp, fngp2)) %>% 
  filter(!cover == 0, !species == "bare") %>% 
   group_by(estuary, disturbance, id, endemic) %>% 
   dplyr::summarize(n.rich.end = n_distinct(species)) %>% 
  mutate(obs = "veg")

mie.rich.endemic$id <- as.character(mie.rich.endemic$id)
sp.rich.endemic <- seed.rich.endemic %>% full_join(mie.rich.endemic, by = c("estuary", "disturbance", "id", "endemic", "n.rich.end", "obs")) 

sp.rich.endemic.mean <- sp.rich.endemic %>% 
  group_by(estuary, disturbance, obs, endemic) %>% 
  dplyr::summarize(sp.rich.end = n(),
            sp.rich.end.mean = mean(n.rich.end), 
            sp.rich.end.sd = sd(n.rich.end), 
            sp.rich.end.se = sp.rich.end.sd/sqrt(sp.rich.end))

pd.seed <- position_dodge(0.15)
sp.rich.endemic.mean$estuary = factor(sp.rich.endemic.mean$estuary, levels = c("ere", "nre", "lqre"))
sp.rich.endemic.mean$disturbance = factor(sp.rich.endemic.mean$disturbance,
                                          levels = c("grubbed", "excl1", "excl10", "reference"), 
                                          labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) 

seedveg.rich.endemic <- sp.rich.endemic.mean %>%  
  ggplot(aes(x=disturbance, y=sp.rich.end.mean, shape = obs, color = endemic)) +   
  ylim(0, 8) +
  geom_point(size = 7, position = pd.seed) +
  geom_errorbar(aes(ymin = sp.rich.end.mean - sp.rich.end.se, 
                    ymax = sp.rich.end.mean + sp.rich.end.se),
                width = .1, 
                position = pd.rich) + 
  labs(x = "Disturbance Condition", y = "Mean Species Richness", shape = "Life Stage", color = "Species \nEndemic Status") +
  theme_classic()+
  theme(text = element_text(size = 20), 
          panel.spacing.x = unit(1.25, "lines"), 
          axis.text.x = element_text(angle = 25, hjust = 1)) +
  facet_grid(. ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels)) + 
  theme(panel.spacing = unit(2, "lines")) +
  scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Seed Bank")) +
  scale_color_manual(limits = c("Native", "Invasive"), labels = c("Native", "Invasive"), values = c("#01665E", "#BF812D"))

#ggsave("fig-sprich-seedveg.jpg", seedveg.rich.endemic, width = 15, height = 6)


```

```{r NMDS just veg}

veg <-  mie %>%
  select(-c(site, sal, obs, elev, life, root, clade, endemic, fngp, fngp2)) %>% 
  filter(!cover == 0, !species == "bare") %>% 
   group_by(estuary, disturbance) %>% 
  pivot_wider(names_from = species, values_from = cover) %>% 
    mutate_all(~replace(., is.na(.), 0)) 

View(veg)
######################
# NMDS based on species presence using Bray's distance
#################################

# matrix of species presence/absence
veg.pa = veg[,5:ncol(veg)]

############################################
#turn abundance data frame into a matrix
############################################
veg.matrix = as.matrix(veg.pa)

############################################
# Stress
############################################
#all
set.seed(123)
nmds.veg = metaMDS(veg.matrix, distance = "bray")
nmds.veg
# stress = 0.174

############################################
#extract NMDS scores (x and y coordinates)
############################################
ds.veg = as.data.frame(scores(nmds.veg)$sites)
View(ds.veg)
#any(is.na(ds.veg))

############################################
#add columns to data frame 
############################################
ds.veg$id = veg$id

ds.veg$disturbance = veg$disturbance

ds.veg$estuary = veg$estuary

############################################
# PLOT
############################################

## all
ds.veg$estuary = factor(ds.veg$estuary, levels = c("ere", "nre", "lqre"))
ds.veg$disturbance <- as.factor(ds.veg$disturbance)

veg.nmds = ggplot(ds.veg, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance, shape = estuary)) + 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", shape = "Estuary", y = "NMDS2", caption = "Above-ground species relative abundance (Bray's distance), stress = 0.174")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
    scale_colour_brewer(palette = "PRGn", limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
    scale_shape_discrete(limits = c("ere", "nre", "lqre"), labels = c("Englishman", "Nanaimo", "Little Qualicum"))
veg.nmds

#ggsave("fig-nmds-veg.jpg", veg.nmds, width = 15, height = 6)


# # was trying to tease apart each estuary into a separate nmds panel, however matrix is based on pooled species, therefore must run nmds for each estuary separately - see next chunk; likely delete this when done
# facet.veg.nmds = ggplot(ds.veg, aes(x = NMDS1, y = NMDS2)) + 
#     geom_point(size = 6, aes(colour = disturbance))+ 
#     theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"), 
#     axis.text.x = element_text(colour = "black", face = "bold", size = 14), 
#     legend.text = element_text(size = 14, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
#     legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
#     axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
#     legend.title = element_text(size = 14, colour = "black", face = "bold"), 
#     panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
#     legend.key=element_blank()) + 
#     facet_grid(. ~ estuary, labeller = labeller(estuary = facet_labels)) + 
#     labs(x = "NMDS1", colour = "Disturbance", shape = "Estuary", y = "NMDS2", caption = "above-ground species presence/absence (Bray's distance), stress = 0.122")  + 
#     theme(strip.text.x = element_text(size = 14, face = "bold")) +
#     scale_colour_brewer(palette = "PRGn", limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed")) +
#     scale_shape_discrete(limits = c("ere", "nre", "lqre"), labels = c("Englishman", "Nanaimo", "Little Qualicum"))
# facet.veg.nmds




```

```{r NMDS veg by estuary}


veg.ere <- veg %>% filter(estuary == "ere")

veg.nre <- veg %>% filter(estuary == "nre")

veg.lqre <- veg %>% filter(estuary == "lqre")

######################
# NMDS based on species presence using Bray's distance
#################################

# matrix of species presence/absence
veg.pa.ere = veg.ere[,4:ncol(veg.ere)]
veg.pa.nre = veg.nre[,4:ncol(veg.nre)]
veg.pa.lqre = veg.lqre[,4:ncol(veg.lqre)]

############################################
#turn abundance data frame into a matrix
############################################
veg.matrix.ere = as.matrix(veg.pa.ere)
veg.matrix.nre = as.matrix(veg.pa.nre)
veg.matrix.lqre = as.matrix(veg.pa.lqre)

############################################
# Stress
############################################

#ERE
set.seed(123)
nmds.veg.ere = metaMDS(veg.matrix.ere, distance = "bray")
nmds.veg.ere
#stress = 0.099

# NRE
set.seed(123)
nmds.veg.nre = metaMDS(veg.matrix.nre, distance = "bray")
nmds.veg.nre
# stress = 0.120

# LQRE
set.seed(123)
nmds.veg.lqre = metaMDS(veg.matrix.lqre, distance = "bray")
nmds.veg.lqre
# stress = 0.095

############################################
#extract NMDS scores (x and y coordinates)
############################################
ds.veg.ere = as.data.frame(scores(nmds.veg.ere))
ds.veg.nre = as.data.frame(scores(nmds.veg.nre))
ds.veg.lqre = as.data.frame(scores(nmds.veg.lqre))

############################################
#add columns to data frame 
############################################
ds.veg.ere$id = veg.ere$id
ds.veg.nre$id = veg.nre$id
ds.veg.lqre$id = veg.lqre$id

ds.veg.ere$disturbance = veg.ere$disturbance
ds.veg.nre$disturbance = veg.nre$disturbance
ds.veg.lqre$disturbance = veg.lqre$disturbance

ds.veg.ere$estuary = veg.ere$estuary
ds.veg.nre$estuary = veg.nre$estuary
ds.veg.lqre$estuary = veg.lqre$estuary

############################################
# PLOT
############################################


## ERE
ds.veg.ere$disturbance <- as.factor(ds.veg.ere$disturbance)
#brewer.pal(n=11,"PRGn")

veg.nmds.ere = ggplot(ds.veg.ere, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance))+ 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", y = "NMDS2", title = "Englishman", caption = "stress = 0.099")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
     scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837"))
veg.nmds.ere


## NRE
ds.veg.nre$disturbance <- as.factor(ds.veg.nre$disturbance)

veg.nmds.nre = ggplot(ds.veg.nre, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance))+ 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", y = "NMDS2", title = "Nanaimo", caption = "stress = 0.120")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
    scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837"))
veg.nmds.nre

## LQRE
ds.veg.lqre$disturbance <- as.factor(ds.veg.lqre$disturbance)

veg.nmds.lqre = ggplot(ds.veg.lqre, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(colour = disturbance))+ 
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", y = "NMDS2", title = "Little Qualicum", caption = "stress = 0.095")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
     scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837"))
veg.nmds.lqre

veg.nmds.ere
veg.nmds.nre
veg.nmds.lqre



## panel format w/ ggpubr
veg.panel <- ggarrange(veg.nmds.ere, veg.nmds.nre, veg.nmds.lqre,  # + rremove("x.text")
          common.legend = TRUE, legend = "bottom",
          ncol = 3, nrow = 1) %>% 
  annotate_figure(bottom = text_grob("Above-ground vegetation species presence/absence (Bray's distance)", hjust = 1, x = 1,  size = 20))
veg.panel

#ggsave("fig-nmds-veg-panel.jpg", veg.panel, width = 15, height = 6)

```



```{r nmds seed vs veg presence/absence, ggarrange by estuary}
# uses pa_join from chunk above

pa.join.ere <- pa.join %>% filter(estuary == "ere")
pa.join.nre <- pa.join %>% filter(estuary == "nre")
pa.join.lqre <- pa.join %>% filter(estuary == "lqre")


#################################
##3. NMDS based on species presence using Bray's distance
#################################

# matrix of species presence/absence
pa.com.ere = pa.join.ere[,7:ncol(pa.join.ere)]
pa.com.nre = pa.join.nre[,7:ncol(pa.join.nre)]
pa.com.lqre = pa.join.lqre[,7:ncol(pa.join.lqre)]


#turn abundance data frame into a matrix
m.com.ere = as.matrix(pa.com.ere)  
m.com.nre = as.matrix(pa.com.nre)
m.com.lqre = as.matrix(pa.com.lqre)


set.seed(123)
nmds.seedveg.ere = metaMDS(m.com.ere, distance = "bray")
nmds.seedveg.ere
# stress = 0.121

set.seed(123)
nmds.seedveg.nre = metaMDS(m.com.nre, distance = "bray")
nmds.seedveg.nre
# stress = 0.087

set.seed(123)
nmds.seedveg.lqre = metaMDS(m.com.lqre, distance = "bray")
nmds.seedveg.lqre
# stress = 0.141


#extract NMDS data scores (x and y coordinates)
ds.seedveg.ere = as.data.frame(scores(nmds.seedveg.ere))
ds.seedveg.nre = as.data.frame(scores(nmds.seedveg.nre))
ds.seedveg.lqre = as.data.frame(scores(nmds.seedveg.lqre))


#add columns to data frame 
ds.seedveg.ere$id = pa.join.ere$id
ds.seedveg.nre$id = pa.join.nre$id
ds.seedveg.lqre$id = pa.join.lqre$id


ds.seedveg.ere$disturbance = pa.join.ere$disturbance
ds.seedveg.nre$disturbance = pa.join.nre$disturbance
ds.seedveg.lqre$disturbance = pa.join.lqre$disturbance


ds.seedveg.ere$obs = pa.join.ere$obs
ds.seedveg.nre$obs = pa.join.nre$obs
ds.seedveg.lqre$obs = pa.join.lqre$obs


ds.seedveg.ere$estuary = pa.join.ere$estuary
ds.seedveg.nre$estuary = pa.join.nre$estuary
ds.seedveg.lqre$estuary = pa.join.lqre$estuary


## plot

## ERE
ds.seedveg.ere$disturbance <- as.factor(ds.seedveg.ere$disturbance)

seedveg.nmds.ere = ggplot(ds.seedveg.ere, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(shape = obs, colour = disturbance))+ 
    #xlim(-1,1.5) + ylim(-1,1) +
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", shape = "Life Stage", y = "NMDS2", title = "Englishman", caption = "stress = 0.121")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
    scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837")) +
  scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Seed Bank"))
seedveg.nmds.ere

## NRE
ds.seedveg.nre$disturbance <- as.factor(ds.seedveg.nre$disturbance)

seedveg.nmds.nre = ggplot(ds.seedveg.nre, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(shape = obs, colour = disturbance))+ 
    #xlim(-1,1.7) + ylim(-1,1) +
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", shape = "Life Stage", y = "NMDS2", title = "Nanaimo", caption = "stress = 0.087")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
    scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837")) +
  scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Seed Bank"))
seedveg.nmds.nre


## LQRE
ds.seedveg.lqre$disturbance <- as.factor(ds.seedveg.lqre$disturbance)

seedveg.nmds.lqre = ggplot(ds.seedveg.lqre, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 6, aes(shape = obs, colour = disturbance))+ 
    #xlim(-1,1.5) + ylim(-1,1) +
    theme(axis.text.y = element_text(colour = "black", size = 20, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 20), 
    legend.text = element_text(size = 20, face ="bold", colour ="black", lineheight = 0.8), legend.key.height = unit(1, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 20), 
    axis.title.x = element_text(face = "bold", size = 20, colour = "black"), 
    legend.title = element_text(size = 20, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Disturbance", shape = "Life Stage", y = "NMDS2", title = "Little Qualicum", caption = "stress = 0.141")  + 
    theme(strip.text.x = element_text(size = 20, face = "bold"), plot.caption = element_text(size = 20)) +
    scale_color_manual(limits = c("grubbed", "excl1", "excl10", "reference"), labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"), values = c("#762A83", "#C2A5CF", "#A6DBA0", "#1B7837")) +
  scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Seed Bank"))
seedveg.nmds.lqre

## panel format w/ ggpubr
seedveg.nmds.panel <- ggarrange(seedveg.nmds.ere, seedveg.nmds.nre, seedveg.nmds.lqre,
          common.legend = TRUE, legend = "bottom",
          ncol = 3, nrow = 1) %>% 
  annotate_figure(bottom = text_grob("Compositional similarity of seed bank vs. above-ground vegetation based on species presence/absence (Bray's distance)", hjust = 1, x = 1,  size = 14))
seedveg.nmds.panel

#ggsave("fig-nmds-seedveg-panel.jpg", seedveg.nmds.panel, width = 20, height = 6)


```

```{r iterative addition of veg & seed by endemic guild & life stage}

# code has been canibalized & moved to different chunks; delete later
###############################################
### By PFG
###############################################





###############################################
# annuals
###############################################
# 
# abund.annual <- pfg.abund.mean %>% 
#   filter(endemic.fngp2 %in% c("Annual, Native", "Annual, Invasive"))
# #View(abund.annual)
# 
# plot.abund.annual <- abund.annual %>%  
#   ggplot(aes(x=disturbance, y=sp.abund.mean, color = endemic.fngp2, shape = obs)) +   
#   geom_jitter(size = 7, position = pd.abund) +
#   ylim(0, 100)+
#   geom_errorbar(aes(ymin = sp.abund.mean - sp.abund.se, 
#                     ymax = sp.abund.mean + sp.abund.se), 
#                 width = .3, position = pd.abund) +
#   labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", color = "Functional Group & \nEndemic Status", shape = "Life Stage") +
#   theme_classic()+
#   theme(text = element_text(size = 20), 
#           panel.spacing.x = unit(1.25, "lines"), 
#           axis.text.x = element_text(angle = 25, hjust = 1)) +
#   facet_grid(. ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels)) +
#   scale_color_manual(values = abund.col) +
#   scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Seed Bank"))
# plot.abund.annual
# 
# #ggsave("fig-abund-ann.jpg", plot.abund.annual, width = 15, height = 6)
# 
# 
# ###############################################
# # annuals + perennial forbs
# ###############################################
# 
# 
# abund.ann.per <- pfg.abund.mean %>% 
#   filter(endemic.fngp2 %in% c("Annual, Native", "Annual, Invasive", "Perennial Forb, Native", "Perennial Forb, Invasive"))
# 
# plot.abund.ann.per <- abund.ann.per %>%  
#   ggplot(aes(x=disturbance, y=sp.abund.mean, color = endemic.fngp2, shape = obs)) +   
#   geom_jitter(size = 7, position = pd.abund) +
#   ylim(0, 100)+
#   geom_errorbar(aes(ymin = sp.abund.mean - sp.abund.se, 
#                     ymax = sp.abund.mean + sp.abund.se), 
#                 width = .3, position = pd.abund) +
#   labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", color = "Functional Group & \nEndemic Status", shape = "Life Stage") +
#   theme_classic()+
#   theme(text = element_text(size = 20), 
#           panel.spacing.x = unit(1.25, "lines"), 
#           axis.text.x = element_text(angle = 25, hjust = 1)) +
#   facet_grid(. ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels)) +
#   scale_color_manual(values = abund.col) +
#   scale_shape_manual(values = c(15, 17), limits = c("veg", "seed"), labels = c("Vegetation", "Surface Seed Bank"))
# plot.abund.ann.per
# 
# #ggsave("fig-abund-ann-per.jpg", plot.abund.ann.per, width = 15, height = 6)


###############################################
### All groups, by PFG
###############################################

#### plot 
abund.col.veg <- c("#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A", "#B2DF8A", "#33A02C", "#B3B3B3") 

plot.abund <- pfg.abund.mean %>% 
  ggplot(aes(x=disturbance, y=sp.abund.mean, color = endemic.fngp2, shape = obs)) +   
  geom_jitter(size = 7, position = pd.abund) +
  ylim(0, 100)+
  geom_errorbar(aes(ymin = sp.abund.mean - sp.abund.se, 
                    ymax = sp.abund.mean + sp.abund.se), 
                width = .3, position = pd.abund) +
  labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", color = "Functional Group & \nEndemic Status", shape = "Life Stage") +
  theme_classic()+
  theme(text = element_text(size = 20), 
          panel.spacing.x = unit(1.25, "lines"), 
          axis.text.x = element_text(angle = 25, hjust = 1)) +
  facet_grid(. ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels)) +
  scale_color_manual(values = abund.col) +
  scale_shape_manual(values = c(15, 17, 18), limits = c("veg", "seed", "bare"), labels = c("Vegetation", "Surface Seed Bank", "Unvegetated"))

plot.abund

#ggsave("fig-abund-all.jpg", plot.abund, width = 15, height = 6)

###############################################
### Just veg, by PFG
###############################################

pfg.abund.mean.veg <- ra.join %>%
  filter(obs == "veg") %>%
  group_by(estuary, disturbance, obs, endemic, fngp2) %>%
  dplyr::summarize(n.abund = n(),
            sp.abund.mean = mean(rel.abund),
            sp.abund.sd = sd(rel.abund),
            sp.abund.se = sp.abund.sd/sqrt(n.abund)) %>%
  mutate_all(~replace(., is.na(.), 0))%>%
  filter(!endemic == "NA")
#View(pfg.abund.mean.veg)


#### plot setup

pfg.abund.mean.veg$estuary = factor(pfg.abund.mean.veg$estuary, levels = c("ere", "nre", "lqre"))
pfg.abund.mean.veg$disturbance = factor(pfg.abund.mean.veg$disturbance,
                                          levels = c("grubbed", "excl1", "excl10", "reference"),
                                          labels = c("Grubbed", "Heavily Grazed, \nExclosed 1 year", "Heavily Grazed, \nExclosed 10 years", "Undisturbed"))
# pfg.abund.mean.veg$endemic.fngp2 = factor(pfg.abund.mean.veg$endemic.fngp2,
#                                           levels = c("Native Annual", "Invasive Annual", "Native Perennial forb", "Invasive Perennial forb", "Native Perennial graminoid", "Invasive Perennial graminoid"),
#                                           labels = c("Annual, Native", "Annual, Invasive", "Perennial Forb, Native", "Perennial Forb, Invasive", "Perennial Graminoid, Native", "Perennial Graminoid, Invasive"))

#### plot 
abund.col.veg <- c("#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A", "#B2DF8A", "#33A02C") 

veg.fngp.abund <- pfg.abund.mean.veg %>% 
  ggplot(aes(x=disturbance, y=sp.abund.mean, color = endemic, shape = fngp2)) +   
  geom_jitter(size = 7, position = pd.abund) +
  ylim(0, 100)+
  geom_errorbar(aes(ymin = sp.abund.mean - sp.abund.se, 
                    ymax = sp.abund.mean + sp.abund.se), 
                width = .3, position = pd.abund) +
  labs(x = "Disturbance condition", y = "Mean Relative Abundance (%)", color = "Endemic Status", shape = "Functional Group") +
  theme_classic()+
  theme(text = element_text(size = 20), 
          panel.spacing.x = unit(1.25, "lines"), 
          axis.text.x = element_text(angle = 25, hjust = 1)) +
  facet_grid(. ~ estuary, scales = "free", labeller = labeller(estuary = facet_labels)) +
  scale_color_brewer(palette = "Set2", direction = -1)

veg.fngp.abund

#ggsave("fig-abund-veg-fngp.jpg", veg.fngp.abund, width = 15, height = 6)


### Cut error bars if < 0

  # geom_errorbar(aes(ymin = ifelse(sp.abund.mean - sp.abund.se <0,0, sp.abund.mean - sp.abund.se),
  #                   ymax = ifelse(sp.abund.mean + sp.abund.se >1,1, sp.abund.mean + sp.abund.se)),
  #               width = .3, position = pd.abund) + 

```


```{r RA mean & SE by life history stage}

#######################################
# Relative abundance mean & SE by life history stage
#######################################

ra.mean.se <- ra.join %>% 
  group_by(estuary, disturbance, endemic.fngp2, obs) %>% 
  dplyr::summarize(ra.n = n(),
            ra.mean = mean(rel.abund), 
           ra.sd = sd(rel.abund), 
            ra.se = ra.sd/sqrt(ra.sd)) %>% 
    mutate_all(~replace(., is.na(.), 0)) 

#View(ra.mean.se)

ra.mean.se.ere <- filter(ra.mean.se, estuary=="ere")
ra.mean.se.nre <- filter(ra.mean.se, estuary=="nre")
ra.mean.se.lqre <- filter(ra.mean.se, estuary=="lqre")


pd.ra = position_dodge(0.25)

ra.seedveg.ere <- ra.mean.se.ere %>%  
  ggplot(aes(x=disturbance, y=ra.mean, color = endemic.fngp2, shape = obs)) +   
  geom_jitter(position = pd.ra, 
             size = 7) +
  geom_errorbar(aes(ymin = ifelse(ra.mean - ra.se <0,0, ra.mean - ra.se), 
                    ymax = ra.mean + ra.se),
                width = .3, 
                position = pd.ra) + 
  labs(x = "", y = "Mean Relative Abundance", color = "Plant Functional Group", shape = "Life Stage") +
  theme_classic()+
   theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"), 
    axis.text.x = element_text(colour = "black", size = 14, angle = 25, hjust = 1), 
    legend.text = element_text(size = 14, colour ="black", lineheight = 1), legend.key.height = unit(1.15, "cm"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
  labs(title = "Englishman") +
  scale_x_discrete(limits = c("grubbed", "reference"), labels = c("Grubbed", "Undisturbed")) +
  scale_y_continuous(limits=c(0,1), breaks=c(0, 0.25, 0.5, 0.75, 1)) +
  scale_shape_discrete(limits = c("veg", "seed"), labels = c("Vegetation", "Seed Bank")) +
  scale_color_brewer(palette = "Dark2")
ra.seedveg.ere






```

OLD ANALYSIS - MESSY, EXTRANEOUS DATA BELOW THIS LINE


```{r setup ABOVE GROUND summary stats}

# dMIE <- read.csv("2021_dMIE.csv")
# #View(dMIE)
# 
# dMIE$Exclosure_date <- factor(dMIE$Exclosure_date, levels = c("Grubbed", "2020", "2016", "2010", "Reference"))
# dMIE$Estuary <- factor(dMIE$Estuary, levels = c("LQRE", "ERE", "NRE"),
#                   labels = c("Little Qualicum", "Englishman", "Nanaimo"))

# Species info
# "Agropyron_repens" graminoid, non-native, perennial, rhizomatous    NOMENCLATURE UPDATE: Elymus repens
# "Agrostis_gigantea" graminoid, non-native, perennial, rhizomatous   NOMENCLATURE UPDATE: Agrostis stolonifera
# "Atriplex_patula" forb, non-native, annual, taproot
# "Carex_lyngbyei" graminoid, native, perennial, rhizomatous
# "Cotula_coronopifolia" forb, non-native, perennial, fibrous
# "Daucus_carota" forb, non-native, biennial (perennial), taproot
# "Deschampsia_cespitosa" graminoid, native, perennial, fibrous
# "Distichlis_spicata" graminoid, native, perennial, rhizomatous
# "Glaux_maritima" forb, native, perennial, rhizomatous
# "Isolepis_cernua" graminoid, native, annual, fibrous
# "Juncus_balticus" graminoid, native, perennial, rhizomatous
# "Polygonum_fowlerii" forb, native, annual, taproot                  SPELLING: Polygonum fowleri
# "Potentilla_anserina_pacifica" forb, native, perennial, rhizomatous
# "Salicornia_depressa" forb, native, annual, fibrous
# "Scirpus_microcarpus" graminoid, native, perennial, rhizomatous
# "Spergularia_canadensis" forb, native, annual, taproot
# "Symphotrichium_subspicatum" forb, native, perennial, rhizomatous   SPELLING : Sympohtricum 
# "Trifolium_wormskioldii" forb, native, perennial, taproot
# "Triglochin_maritima" forb, native, perennial, rhizomatous
# 
# MIE_long <- dMIE %>% 
#   filter(!(ID==c(1:12)) & !(ID==c(17:24))) %>% 
#   pivot_longer(Agropyron_repens:No_cover, names_to = "Species", values_to = "Cover") %>%
#   mutate(Endemic = ifelse(Species %in% c("Agropyron_repens", "Agrostis_gigantea", "Atriplex_patula", "Cotula_coronopifolia", "Daucus_carota"), "Invasive",
#                    ifelse(Species %in% "No_cover", "NA", "Native"))) %>% 
#   mutate(LifeHistory = ifelse(Species %in% c("Atriplex_patula", "Isolepis_cernua", "Polygonum_fowlerii", "Salicornia_depressa", "Spergularia_canadensis"), 
#                               "Annual", ifelse(Species %in% "No_cover", "NA", "Perennial"))) %>% 
#   mutate(Root = ifelse(Species %in% c("Atriplex_patula", "Daucus_carota", "Polygonum_fowlerii", "Trifolium_wormskioldii"), "Taproot", 
#                 ifelse(Species %in% c("Cotula_coronopifolia", "Deschampsia_cespitosa", "Isolepis_cernua", "Salicornia_depressa"), "Fibrous",
#                 ifelse(Species %in% "No_cover", "NA", "Rhizomatous")))) %>% 
#   mutate(Clade = ifelse(Species %in% c("Agropyron_repens", "Agrostis_gigantea", "Carex_lyngbyei", "Deschampsia_cespitosa", "Distichlis_spicata", 
#                                       "Isolepis_cernua", "Juncus_balticus", "Scirpus_microcarpus"), "Graminoid",
#                 ifelse(Species %in% "No_cover", "NA", "Forb"))) %>% 
#   mutate(Fn_gp = ifelse(Species %in% c("Agropyron_repens", "Agrostis_gigantea", "Carex_lyngbyei", "Distichlis_spicata", "Juncus_balticus", "Scirpus_microcarpus"), "Perennial graminoid, rhizomatous roots",
#                   ifelse(Species %in% c("Isolepis_cernua"), "Annual graminoid, fibrous roots", 
#                   ifelse(Species %in% c("Deschampsia_cespitosa"), "Perennial graminoid, fibrous roots",
#                   ifelse(Species %in% c("Atriplex_patula", "Polygonum_fowlerii", "Salicornia_depressa", "Spergularia_canadensis"), "Annual forb", 
#                   ifelse(Species %in% c("Cotula_coronopifolia", "Daucus_carota", "Trifolium_wormskioldii"), "Perennial forb, fibrous roots",
#                   ifelse(Species %in% c("Triglochin_maritima", "Glaux_maritima", "Potentilla_anserina_pacifica", "Symphotrichium_subspicatum"), 
#                          "Perennial forb, rhizomatous roots", "Unvegetated")))))))
#                   
# # want to show: relative cover abundance of native, rhizomatous, graminoids over time
# 
# 
# MIE_long$Fn_gp <- factor(MIE_long$Fn_gp, levels = c("Annual forb", "Annual graminoid, fibrous roots", "Perennial forb, fibrous roots", "Perennial forb, rhizomatous roots",  "Perennial graminoid, fibrous roots", "Perennial graminoid, rhizomatous roots", "Unvegetated"))
# 
# ggplot(MIE_long, aes(fill=Fn_gp, y=Cover, x=Exclosure_date)) + 
#     geom_bar(position="fill", stat="identity") +
#     theme_classic()+
#     facet_grid(~Estuary, scales = "free", space = "free") + 
#     theme(text = element_text(size = 20), 
#           panel.spacing.x = unit(1.25, "lines"), 
#           axis.text.x = element_text(angle = 45, hjust = 1)) +
#     labs(y="Relative Abundance 
#          (% cover)", x="Disturbance condition", fill = "Plant Functional Group") +
#     scale_fill_brewer(palette = "Spectral")  
#    #scale_x_discrete(labels=c("Grubbed" = "0", "2020" = "1", "2016" = "5", "2010" = "10", "Reference" = "Undisturbed"))
# 
# 
# 
# 
# ```
# 
# ```{r setup, functional groups boxplots}
# MIE_gps <- MIE_long %>% select(Estuary, Exclosure_date, Cover, Fn_gp) %>% 
#   filter(Fn_gp == "Perennial graminoid, rhizomatous roots") %>% 
#   group_by(Estuary)
# 
# ggplot(data = MIE_gps, 
#     aes(x = Exclosure_date, y = Cover, fill = Estuary))+
#     theme(text = element_text(size = 20)) +
#     geom_boxplot(size=1, alpha = 1/10)+ theme_classic()+
#     #facet_grid(Estuary ~ Fn_gp, scales = "free", space = "free")+ 
#     theme(panel.spacing.x = unit(1.25, "lines")) +
#     theme(axis.text.x = element_text(angle=45, margin = margin(t=20, r=100)))+
#     labs(y="Above-ground cover", x="Disturbance Condition", caption = "n = 4 per exclosure status") 


```

```{r setup LM for functional gps}




#abbreviated workflow from Zurr et al, 2009
# bit of a mess below this line - 
#############################
# Linear regression, no model testing
#############################
library(ggpubr)

# want to show trend of functional groups over time

lm_fn <- y ~ x

ggplot(MIE_gps, aes(x = Exclosure_date, y = Cover, color = Estuary)) + #, add = "reg.line"
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(x = "Exclosure status", y = "Avg. plot cover", caption = "geom_jitter + geom_smooth(method = lm)") +
  #stat_regline_equation(aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), formula = lm_fn) +
  theme_classic() +
  theme(axis.text.x = element_text(margin = margin(t=20, r=100), angle = 45))+
  theme(text = element_text(size = 14)) +
  scale_x_continuous(breaks = c(0, 1, 5, 15), labels = c("Grubbed", "2020", "2016", "Reference")) 
#ggsave("2021_CALY_LM.png",  width = 9, height = 6, units = "in")


#############################
# A.2 Data Exploration
#############################
# Cleveland dotplots (pdf pg. 532)
library(graphics)
data(MIE_gps)
#MIE_gps$fExclosure_date <- factor(MIE_gps$Exclosure_date)
op <- par(mfrow = c(1, 3), mar = c(3, 3, 3, 1))
dotchart(MIE_gps$Plot_elev_m_AMLL, main = "Elevation", group = MIE_gps$fExclosure_date)
dotchart(MIE_gps$Cover, main = "Rhizomatous graminoid cover", group = MIE_gps$fExclosure_date)
#dotchart(MIE_gps$mean_EC_mS, main = "Salinity", group = MIE_gps$fExclosure_date)
par(op)

# Colinearity
## To assess collinearity, we will use three tools: Pairwise scatterplots, correlation
## coefficients, and variance inflation factors (VIF).

 Z <- cbind(MIE_gps$Exclosure_date, MIE_gps$Cover)
 colnames(Z) <- c("Exclosure Age", "Cover")
 pairs(Z)
 
 ## correlation & variance values
 cor(Z)
 var(Z)
 #VIF won't run on atomic vector - can run on LM output (see Chunk 9 ("Lm"))
 #vif(Z)
 
 #############################
 # A.3 Linear Regression
 #############################
 # Linear regression w/ no interactions
 M1 <- lm(Cover ~ Exclosure_date, data = MIE_gps)
 
summary(M1)
drop1(M1, test="F")
anova(M1) # order of interaction terms changes significance - try switching Elev & Salinity in lm() and observe change in ANOVA; see Zuur pg. 540 (pdf 546)



```

```{r setup SEEDS summary stats}

d_seed <- read.csv("2021_Seedlings_wider.csv")
## "Atriplex_patula"             
## "Agrostis_stolonifera"         
## "Salicornia_depressa"          
## "Spergularia_canadensis"       
## "Cotula_coronopifolia"        
## "Isolepis_cernua"              
##"Deschampsia_cespitosa"        
# "Potentilla_anserina_pacifica" 
# "Carex_lyngbyei"               
# "Symphyotrichum_subspicatum"   
# "Achillea_millefolium"        
# "Cirsium_sp"                   
# "Glaux_maritima"   

#long data
seeds <- d_seed %>% 
  #filter(!(Estuary == "Englishman")) %>% 
  pivot_longer(Atriplex_patula:Glaux_maritima, names_to = "Species", values_to = "Seedlings_ct") %>% 
  filter(Seedlings_ct > 0) %>% 
  group_by(Estuary, Exclosure_date) %>% 
   mutate(Fn_gp_seed = ifelse(Species %in% c("Agrostis_stolonifera", "Carex_lyngbyei"), "Perennial graminoid, rhizomatous roots",
                  ifelse(Species %in% c("Isolepis_cernua"), "Annual graminoid, fibrous roots", 
                  ifelse(Species %in% c("Deschampsia_cespitosa"), "Perennial graminoid, fibrous roots",
                  ifelse(Species %in% c("Atriplex_patula", "Salicornia_depressa", "Spergularia_canadensis"), "Annual forb", 
                  ifelse(Species %in% c("Cotula_coronopifolia", "Cirsium_sp", "Achillea_millefolium"), "Perennial forb, fibrous roots", "Perennial forb, rhizomatous roots")))))) 

sum_fn <- seeds %>% 
  group_by(Estuary, Exclosure_date, Fn_gp_seed) %>% 
  dplyr::summarise(Seed_ct = sum(Seedlings_ct))

#Number seedlings per 0.02 m2
# see http://www.sthda.com/english/wiki/ggplot2-dot-plot-quick-start-guide-r-software-and-data-visualization 
sum_fn$Exclosure_date <- factor(sum_fn$Exclosure_date, levels = c("Grubbed", "2020", "2016", "Reference"))
ggplot(sum_fn, aes(x = Exclosure_date, y=Seed_ct, shape = Estuary, color = Fn_gp_seed))+
  geom_point(size = 8, position =  position_dodge(0.75)) +
  theme_classic() +           
  theme(text = element_text(size = 20)) +
  labs(y="Seedlings (total sum)", x="Disturbance condition", color = "Plant Functional Group", caption = "Pilot germination: sum of seeds by species in 0.02 m2 no-drain trays (n = 6 per age class & estuary)") +
  scale_color_manual(values = c("#D53E4F", "#FC8D59", "#FEE08B", "#FFFFBF", "#E6F598", "#99D594")) 
```

```{r setup SALINITY summary stats}

S <- read.csv("2021_salinity.csv")
avg_S <- S %>%
  group_by(Unique_plot_ID) %>%
  summarize(mean_EC_mS = mean(EC_mScm.1, na.rm = TRUE))

#exclude ERE b/c data not representative
sMIE <- dMIE %>%
  left_join(avg_S, by = "Unique_plot_ID", na.rm = TRUE)
#Species presence/absence


```

```{r richness & CALY boxplots}

#exclude ERE b/c data not representative
MIE2 <- d_MIE %>% 
  filter(!Estuary == "ERE")

MIE2$Exclosure_date <- factor(MIE2$Exclosure_date, levels = c("Grubbed", "2020", "2016", "2010", "Reference"))
MIE2$Estuary <- factor(MIE2$Estuary, levels = c("LQRE", "NRE"),
                  labels = c("Little Qualicum", "Nanaimo"))

MIE2_long <- MIE2 %>% pivot_longer(Agropyron_repens:No_cover, names_to = "Species", values_to = "Cover") %>% 
  mutate(Status = ifelse(Species %in% c("Agropyron_repens", "Agrostis_gigantea", "Atriplex_patula", "Cotula_coronopifolia", "Daucus_carota"), "Non-native",
                  ifelse(Species %in% "No_cover", "No_cover","Native")))

MIE2_fn_gp <- MIE2_long %>%
mutate(Functional_groups =
    ifelse(Species %in% c("Glaux_maritima", "Isolepis_cernua", "Salicornia_depressa", "Spergularia_canadensis"), "Groundcover (< 15 cm tall) - Native",
    ifelse(Species %in% "Cotula_coronopifolia", "Groundcover (< 15 cm tall) - Non-native",       
    ifelse(Species %in% c("Carex_lyngbyei", "Deschampsia_cespitosa", "Distichlis_spicata", "Juncus_balticus", "Scirpus_microcarpus"), "Graminoid - Native",
    ifelse(Species %in% c("Agropyron_repens", "Agrostis_gigantea"), "Graminoid - Non-native",
    ifelse(Species %in% "No_cover", "No_cover", 
    ifelse(Species %in% c("Atriplex_patula","Daucus_carota"), "Forb - Non-native", "Forb - Native")))))))


MIE2_fn_gp$Functional_groups <- factor(MIE2_fn_gp$Functional_groups,
                  levels = c("Groundcover (< 15 cm tall) - Native", "Groundcover (< 15 cm tall) - Non-native", "Graminoid - Native",
                          "Graminoid - Non-native", "Cespitose graminoid - Native", "Forb - Native", "Forb - Non-native", "No_cover"))

#############################
# Boxplots
#############################
#~~~~~~~~~~~~~~~~
#total richness
#~~~~~~~~~~~~~~~~

# https://kembellab.ca/r-workshop/biodivR/SK_Biodiversity_R.html

# select just species
MIE2_pl <- MIE2 %>%  select(Estuary, Exclosure_date, Site_no, Agropyron_repens:Triglochin_maritima)

# calculate richness
MIE2_pl_rich <- ddply(MIE2_pl, ~Estuary*Exclosure_date*Site_no, function (x) (
  data.frame(RICHNESS = sum(x [,-c(1:3)]>0))
))

mean_MIE2_pl_rich <- setNames(aggregate(MIE2_pl_rich[,4], list(MIE2_pl_rich$Estuary, MIE2_pl_rich$Exclosure_date), mean), c("Estuary", "Exclosure_date", "Mean_species_richness"))

ggplot(data = MIE2_pl_rich, 
    aes(x = Exclosure_date, y = RICHNESS, group = Exclosure_date))+
    theme(text = element_text(size = 20)) +
    geom_boxplot(size=1, alpha = 1/10)+ theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free")+ 
    theme(panel.spacing.x = unit(1.25, "lines")) +
    theme(axis.text.x = element_text(angle=45, margin = margin(t=20, r=100)))+
    labs(y="Species richness", x="Exclosure status", caption = "n = 4 per exclosure status") 
ggsave("2021_Sp-richness_box.jpeg")

#~~~~~~~~~~~~~~~~
# Carex cover
#~~~~~~~~~~~~~~~~
CALY2 <- MIE2 %>% 
  group_by(Estuary, Exclosure_date) %>% 
  select(CALY_cover = "Carex_lyngbyei")

ggplot(data=CALY2, 
    aes(x= Exclosure_date,
    y=CALY_cover, group=Exclosure_date)) +
    theme(text = element_text(size = 20)) +
    geom_boxplot(size=1, alpha = 1/10)+ theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free")+ 
    theme(panel.spacing.x = unit(1.25, "lines")) +
    theme(axis.text.x = element_text(angle=45, margin = margin(t=20, r=100)))+
    labs(y="Carex lyngbyei cover abundance (%)", x="Exclosure status", caption = "n = 4 per exclosure status 
         (transplanting not performed in 2010 exclosures at Little Qualicum)") 
ggsave("2021_CALY_box.jpg")

#############################
# Stacked barcharts
#############################

#~~~~~~~~~~~~~~~~
## Functional groups
#~~~~~~~~~~~~~~~~
#brewer.pal(n=12,"Set2")

ggplot(MIE2_fn_gp, aes(fill=Functional_groups, y=Cover, x=Exclosure_date)) + 
    geom_bar(position="fill", stat="identity") + theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free") + 
    theme(text = element_text(size = 14)) +
    theme(panel.spacing.x = unit(1.25, "lines")) +
    theme(axis.text.x = element_text(margin = margin(t=20, r=100), angle = 45))+
    theme(legend.position = "bottom") +
    guides(fill = guide_legend(title = "Functional Group & Native Status", title.position = "top")) +
    labs(y="Relative plot cover abundance", x="Exclosure status", caption = "n = 4 per exclosure status") +
    scale_fill_brewer(palette = "Paired")  
  #scale_fill_manual(name = "Functional Group & Native Status", values = c("#B3B3B3", "#66C2A5", "#E5C494", "#A6D854", "#FC8D62", "#E78AC3", "#FFD92F")) 
ggsave("2021_FnGp_stacked_bar.jpeg", width = 9, height = 7, units = "in")

#~~~~~~~~~~~~~~~~
## Native vs. Non-native
#~~~~~~~~~~~~~~~~

ggplot(MIE2_long, aes(fill=Status, y=Cover, x=Exclosure_date)) + 
  geom_bar(position="fill", stat="identity") + theme_classic()+
  theme_classic() +
  theme(axis.text.x = element_text(margin = margin(t=20, r=100), angle = 45))+
  theme(text = element_text(size = 14)) +
  theme(panel.spacing.x = unit(1.25, "lines")) +
  facet_grid(~Estuary, scales = "free", space = "free") +
  theme(legend.position = "bottom") +
    guides(fill = guide_legend(title = "Native Status", title.position = "left")) +
  labs(y="Relative plot cover abundance", x="Exclosure status") +
  scale_fill_brewer(palette = "Set2")  
ggsave("2021_Native-status_stacked_bar.jpeg",  width = 7, height = 6, units = "in")

```

```{r CALY LM w/ refined data}
#abbreviated workflow from Zurr et al, 2009

# omit 10 y/o plots from LM
CALY_cover2 <- MIE2_long %>% select(Estuary, Yrs_since_disturb, Elev_m_AMLL, Species, Cover, Site_no, Salinity_mS) %>% 
  group_by(Estuary, Yrs_since_disturb) %>% 
  mutate(Cover = Cover/100) %>% 
  filter(Species == "Carex_lyngbyei", !Yrs_since_disturb == 10)

#############################
# Linear regression, no model testing
#############################
library(ggpubr)

formula <- y ~ x

ggplot(CALY_cover2, aes(x = Yrs_since_disturb, y = Cover, color = Estuary, add = "reg.line")) + 
  geom_jitter() +
  geom_smooth(method = "lm", formula = formula) +
  labs(x = "Exclosure status", y = "Avg. plot proportion sedge cover", caption = "geom_jitter + geom_smooth(method = lm)") +
  stat_regline_equation(aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
    formula = formula) +
  theme_classic() +
  theme(axis.text.x = element_text(margin = margin(t=20, r=100), angle = 45))+
  theme(text = element_text(size = 14)) +
  scale_x_continuous(breaks = c(0, 1, 5, 15), labels = c("Grubbed", "2020", "2016", "Reference")) 
ggsave("2021_CALY_LM.png",  width = 9, height = 6, units = "in")

#############################
# A.2 Data Exploration
#############################
# Cleveland dotplots (pdf pg. 532)
library(graphics)
data(CALY_cover2)
CALY_cover2$fYrs_since_disturb <- factor(CALY_cover2$Yrs_since_disturb)
op <- par(mfrow = c(1, 3), mar = c(3, 3, 3, 1))
dotchart(CALY_cover2$Elev_m_AMLL, main = "Elevation", group = CALY_cover2$fYrs_since_disturb)
dotchart(CALY_cover2$Cover, main = "Carex cover", group = CALY_cover2$fYrs_since_disturb)
dotchart(CALY_cover2$Salinity_mS, main = "Salinity", group = CALY_cover2$fYrs_since_disturb)
par(op)

 #############################
 # A.3 Linear Regression
 #############################
 # Linear regression w/ no interactions
 M1a <- lm(Cover ~ Yrs_since_disturb + Elev_m_AMLL + Salinity_mS, data = CALY_cover2)
 
summary(M1a)
drop1(M1a, test="F")
anova(M1a)

 #############################
 # A.3.2 Model Validation
 #############################

# graphic output of residuals to assess homogeniety, QQ plot of residuals
M2a <- M1a <- lm(Cover ~ fYrs_since_disturb + Elev_m_AMLL + Salinity_mS, data = CALY_cover2)
op2a <- par(mfrow = c(2,2))
plot(M2a) #site ID 15 & 25 appear to be outliers

win.graph(); op <- par(mfrow = c(2, 2))
#Check for normality
E2 <- rstandard(M2a)
list(E2)
qqnorm(E2)
#Check for independence and homogeneity: residuals
#versus individual explanatory variables
plot(y = E2, x = CALY_cover2$Yrs_since_disturb, xlab = "Exclosure Age",
ylab = "Residuals")
abline(0,0)
plot(E2 ~ CALY_cover2$Elev_m_AMLL, xlab = "Elevation",
ylab = "Residuals")
abline(0, 0)
par(op)

##########################
# GAM 
##########################
library(mgcv)

## http://environmentalcomputing.net/intro-to-gams/
CALY_GAM2 <- gam(Cover ~ Yrs_since_disturb + s(Elev_m_AMLL, k = 3), data = CALY_cover2, method = "REML")

# residuals
plot(CALY_GAM2, residuals = TRUE, pch = 1)

par(mfrow = c(2,2))
gam.check(CALY_GAM2)
summary(CALY_GAM2)

# plot

ggplot(CALY_cover2, aes(x = Yrs_since_disturb+Elev_m_AMLL, y = Cover, color = Estuary)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y~s(x), k = 3) +
  labs(x = "Exclosure status", y = "Avg. proportion sedge plot cover ",caption = "geom_point() + geom_smooth(method = gam, formula = y~s(x), k = 3))") +
  theme_classic() +
  theme(axis.text.x = element_text(margin = margin(t=20, r=100), angle = 45))+
  theme(text = element_text(size = 14)) 
  #scale_x_continuous(breaks = c(0, 1, 5, 15), labels = c("Grubbed", "2020", "2016", "Reference")) 
  # legend.key=element_blank() 
ggsave("2021_CALY-GAM.png")

```

```{r LM workflow following Zuur et al, 2009}

# Appendix A: Data exploration
# As with any analysis, before starting the linear regression, we apply a data exploration
# focussing on the following points:
# 1. Outliers in the response and explanatory variables.
# 2. Collinearity of the explanatory variables.
# 3. Relationships between the response variable and the explanatory variables.

CALY_cover <- MIE_long %>% select(Estuary, Exclosure_age_yr, Plot_elev_m_AMLL, Species, Cover, Site_no, mean_EC_mS) %>% 
  group_by(Exclosure_age_yr) %>% 
  mutate(Cover = Cover/100) %>% 
  mutate(Exclosure_age_yr=ifelse(Exclosure_age_yr==25, 20, Exclosure_age_yr)) %>% 
  filter(Species == "Carex_lyngbyei")


  

#############################
# A.2 Data Exploration
#############################
# Cleveland dotplots (pdf pg. 532)
library(graphics)
data(CALY_cover)
CALY_cover$fExclosure_age_yr <- factor(CALY_cover$Exclosure_age_yr)
op <- par(mfrow = c(1, 3), mar = c(3, 3, 3, 1))
dotchart(CALY_cover$Plot_elev_m_AMLL, main = "Elevation", group = CALY_cover$fExclosure_age_yr)
dotchart(CALY_cover$Cover, main = "Carex cover", group = CALY_cover$fExclosure_age_yr)
dotchart(CALY_cover$mean_EC_mS, main = "Salinity", group = CALY_cover$fExclosure_age_yr)
par(op)

# Colinearity
## To assess collinearity, we will use three tools: Pairwise scatterplots, correlation
## coefficients, and variance inflation factors (VIF).

 Z <- cbind(CALY_cover$Plot_elev_m_AMLL, CALY_cover$Exclosure_age_yr, CALY_cover$Cover, CALY_cover$mean_EC_mS)
 colnames(Z) <- c("Elevation", "Exclosure Age", "Cover", "Salinity")
 pairs(Z)
 
 ## correlation & variance values
 cor(Z)
 var(Z)
 #VIF won't run on atomic vector - can run on LM output (see Chunk 9 ("Lm"))
 #vif(Z)
 
 #############################
 # A.3 Linear Regression
 #############################
 # Linear regression w/ no interactions
 M1 <- lm(Cover ~ Exclosure_age_yr + Plot_elev_m_AMLL + mean_EC_mS, data = CALY_cover)
 
summary(M1)
drop1(M1, test="F")
anova(M1) # order of interaction terms changes significance - try switching Elev & Salinity in lm() and observe change in ANOVA; see Zuur pg. 540 (pdf 546)


 #############################
 # A.3.2 Model Validation
 #############################

# graphic output of residuals to assess homogeniety, QQ plot of residuals
M2 <- M1 <- lm(Cover ~ fExclosure_age_yr + Plot_elev_m_AMLL, data = CALY_cover)
op2 <- par(mfrow = c(2,2))
plot(M2)

win.graph(); op <- par(mfrow = c(2, 2))
#Check for normality
E <- rstandard(M2)
list(E)
qqnorm(E)
#Check for independence and homogeneity: residuals
#versus individual explanatory variables
plot(y = E, x = CALY_cover$Exclosure_age_yr, xlab = "Exclosure Age",
ylab = "Residuals")
abline(0,0)
plot(E ~ CALY_cover$Plot_elev_m_AMLL, xlab = "Elevation",
ylab = "Residuals")
abline(0, 0)
par(op)

 #############################
 # A.3.3 Model Interpretation
 #############################
# run from 'plot' to 'lines' 
plot(CALY_cover$Plot_elev_m_AMLL, CALY_cover$Cover)
D1 <- data.frame(Plot_elev_m_AMLL = CALY_cover$Plot_elev_m_AMLL[CALY_cover$Exclosure_age_yr==0], 
    fExclosure_age_yr = "0")
D2 <- data.frame(Plot_elev_m_AMLL = CALY_cover$Plot_elev_m_AMLL[CALY_cover$Exclosure_age_yr==1],
    fExclosure_age_yr = "1")
D3 <- data.frame(Plot_elev_m_AMLL = CALY_cover$Plot_elev_m_AMLL[CALY_cover$Exclosure_age_yr==5],
    fExclosure_age_yr = "5")
D4 <- data.frame(Plot_elev_m_AMLL = CALY_cover$Plot_elev_m_AMLL[CALY_cover$Exclosure_age_yr==10],
    fExclosure_age_yr = "10")
D5 <- data.frame(Plot_elev_m_AMLL = CALY_cover$Plot_elev_m_AMLL[CALY_cover$Exclosure_age_yr==20],
    fExclosure_age_yr = "20")

# fitted lines only cover that part of the gradient for which there are observed measurements for that age class
P1 <- predict(M2, newdata = D1)
P2 <- predict(M2, newdata = D2)
P3 <- predict(M2, newdata = D3)
P4 <- predict(M2, newdata = D4)
P5 <- predict(M2, newdata = D5)

#last bit of the code draws the lines
lines(D1$Plot_elev_m_AMLL, P1, lty = 1)
lines(D2$Plot_elev_m_AMLL, P2, lty = 2)
lines(D3$Plot_elev_m_AMLL, P3, lty = 3)
lines(D4$Plot_elev_m_AMLL, P4, lty = 4)
lines(D5$Plot_elev_m_AMLL, P5, lty = 5)

 #############################
 # A.4 Additive Modeling
 #############################
# If the GAM indicates that the smoother is a straight line, then we know that the linear regression model is correct.
library(mgcv)
#fExclosure_age_yr is a factor
AM1 <- gam(Cover ~ fExclosure_age_yr + s(Plot_elev_m_AMLL) + s(mean_EC_mS), data = CALY_cover)
anova(AM1) #Note that smoothers are not significant at the 5% level; this means that we are back to the data selection process

# The hypothesis testing approach is the easiest; just drop the least significant term from the model, refit the model, and repeat this process until all terms are significant.

#smoother bs = "cs" tells R to use the cubic regression spline with shrinkage. 
## adding Elev + Salinity w/ cs smoothers yields not significiance of smooth terms. -> Salinity not a strong interaction in the model (drop)
## Elev w/ cs smoother yields significance of Elev as a smooth therm
AM2 <- gam(Cover ~ fExclosure_age_yr + s(Plot_elev_m_AMLL, bs = "cs"), data = CALY_cover)
anova(AM2)
plot(AM2, residuals = TRUE, pch = 1)
summary(AM2)

ggplot(CALY_cover, aes(x = Exclosure_age_yr + Plot_elev_m_AMLL, y = Cover, color = Estuary)) + 
  geom_point() + 
  geom_smooth(method = "gam", formula = y ~ x + s(x, bs = "cs")) +
  labs(x = "Time since exclosure (years)", y = "Avg. proportion sedge cover",caption = "gam(Sedge_Cover ~ Exclosure_age_yr + s(Plot_elev_m_AMLL, bs = cs),
       geom_point() + geom_smooth(method = gam)") +
  theme(axis.text.y = element_text(colour = "black", size = 14, face = "bold"),
    axis.text.x = element_text(colour = "black", face = "bold", size = 14),
    legend.text = element_text(size = 14, face ="bold", colour ="black"),
    legend.position = "bottom", axis.title.y = element_text(face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"),
    legend.title = element_text(size = 14, colour = "black", face = "bold"),
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key=element_blank()) +
    scale_x_continuous(breaks = c(0,5,10,15,20), labels = c("0", "5", "10", "15", ">20")) 



# model validation
E.AM2 <- resid(AM2)
Fit.AM2 <- fitted(AM2)
plot(x = Fit.AM2, y = E.AM2, xlab = "Fitted values", ylab = "Residuals")

M3 <- lm(Cover ~ Plot_elev_m_AMLL + fExclosure_age_yr, data = CALY_cover)
anova(M3, AM2, test ="F")

# The underlying null-hypothesis is that both models are the same or formulated
# more mathematically that the smoother is a straight line (1 df). In this case, we
# can reject this null hypothesis as the more complicated model from the GAM; it is
# significantly better at the 5% level

```

``` {r GAM}
# http://environmentalcomputing.net/intro-to-gams/
library(mgcv)

CALY_prop_GAM <- MIE %>% select(Estuary, Exclosure_age_yr, Plot_elev_m_AMLL, Agropyron_repens:Triglochin_maritima) %>% pivot_longer(Agropyron_repens:Triglochin_maritima, names_to = "Species", values_to = "Cover") %>% 
  group_by(Estuary) %>% 
  #mutate(Sedge_Cover = Cover/100) %>% 
  mutate(Exclosure_age_yr=ifelse(Exclosure_age_yr=="25", "20", Exclosure_age_yr)) %>% 
  filter(Species == "Carex_lyngbyei")

CALY_prop_GAM$Exclosure_age_yr <- as.integer(CALY_prop_GAM$Exclosure_age_yr)
 
gam_CALY <- gam(Cover ~ s(Exclosure_age_yr, k = 3) + s(Plot_elev_m_AMLL, k = 3), data = CALY_prop_GAM, method = "REML")
# Limit max df w/ k parameter; see https://www.r-bloggers.com/2021/03/how-to-solve-common-problems-with-gams/ 

# residuals
plot(gam_CALY, residuals = TRUE, pch = 1)

ggplot(CALY_prop_GAM, aes(x = Exclosure_age_yr+Plot_elev_m_AMLL, y = Cover, color = Estuary)) + 
  geom_point() + 
  geom_smooth(method = "gam", formula = y~s(x, k = 3)) +
  labs(x = "Time since exclosure (years)", y = "Avg. sedge cover (%)",caption = "gam(Sedge_Cover ~ s(Exclosure_age_yr, k = 3) + s(Plot_elev_m_AMLL, k = 3), method = REML,
       geom_point() + geom_smooth(method = gam)") +
  theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"),
    axis.text.x = element_text(colour = "black", face = "bold", size = 12),
    legend.text = element_text(size = 14, face ="bold", colour ="black"),
    legend.position = "bottom", axis.title.y = element_text(face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"),
    legend.title = element_text(size = 14, colour = "black", face = "bold"),
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
  legend.key=element_blank()) +
    scale_x_continuous(breaks = c(0,5,10,15,20), labels = c("0", "5", "10", "15", ">20")) 
#ggsave("MIE_gam.svg")


par(mfrow = c(2,2))
gam.check(gam_CALY)
summary(gam_CALY)

```


```{r What are the changes in total richness over time?}
# https://www.flutterbys.com.au/stats/tut/tut13.2.html
# see also
# https://kembellab.ca/r-workshop/biodivR/SK_Biodiversity_R.html

# compare species richness between estuaries & exclosure dates 

MIE_pl <- MIE %>%  select(Estuary, Exclosure_date, Site_no, Agropyron_repens:Triglochin_maritima)

#uses library(plyr)

#####################################
# Species richness per exclosure age
#####################################

MIE_pl_rich <- ddply(MIE_pl, ~Estuary*Exclosure_date*Site_no, function (x) (
  data.frame(RICHNESS = sum(x [,-c(1:3)]>0))
))

mean_MIE_pl_rich <- setNames(aggregate(MIE_pl_rich[,4], list(MIE_pl_rich$Estuary, MIE_pl_rich$Exclosure_date), mean), c("Estuary", "Exclosure_date", "Mean_species_richness"))

# Englishman	Grubbed	3.625		
# Little Qualicum	Grubbed	6.500		
# Nanaimo	Grubbed	4.750		
# Englishman	2020	5.250		
# Little Qualicum	2020	7.000		
# Nanaimo	2020	5.000		
# Little Qualicum	2016	3.625		
# Little Qualicum	2010	4.625		
# Englishman	Reference	6.125		
# Little Qualicum	Reference	4.375	
# Nanaimo	Reference	5.625


#####################################
# Species abundance per exclosure age
#####################################

MIE_pl_abund <- MIE_pl_rich <- ddply(MIE_pl, ~Estuary*Exclosure_date*Site_no, function (x) (
  data.frame(ABUNDANCE = sum(x [,-c(1:3)]))
))
  
mean_MIE_pl_abund <- setNames(aggregate(MIE_pl_rich[,4], list(MIE_pl_rich$Estuary, MIE_pl_rich$Exclosure_date), mean), c("Estuary", "Exclosure_date", "Mean_species_abundance"))
# why is abundance > 100%??
Abund_box <- ggplot(data = MIE_pl_abund, 
    aes(x = Exclosure_date, y = ABUNDANCE, group = Exclosure_date))+
    theme(text = element_text(size = 20)) +
    geom_boxplot(size=1, alpha = 1/10)+ theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free")+ 
    theme(panel.spacing.x = unit(1.25, "lines")) +
    #theme(axis.text.x = element_text(angle=45, margin = margin(t=20, r=100)))+
    labs(title="Abundance (% cover) over time", y="Abundance (% cover)", x="Time since exclosure (years)") +
    scale_x_discrete(labels=c("Grubbed" = "0", "2020" = "1", "2016" = "5", "2010" = "10", "Reference" = "> 20"))
Abund_box

# Englishman	Grubbed	55.69750		
# Little Qualicum	Grubbed	94.10875		
# Nanaimo	Grubbed	45.12000		
# Englishman	2020	96.55875		
# Little Qualicum	2020	98.24625		
# Nanaimo	2020	67.90250		
# Little Qualicum	2016	91.87750		
# Little Qualicum	2010	115.94875		
# Englishman	Reference	90.09875		
# Little Qualicum	Reference	103.75875
# Nanaimo	Reference	94.11625	

```

```{r species richness & abundance boxplots}

MIE %>% 
  group_by(Estuary, Exclosure_date)

MIE_box <-ggplot(data=MIE, 
    aes(x= Exclosure_date,
    y=Richness, group=Exclosure_date)) +
    theme(text = element_text(size = 20)) +
    geom_boxplot(size=1, alpha = 1/10)+ theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free")+ 
    theme(panel.spacing.x = unit(1.25, "lines")) +
    #theme(axis.text.x = element_text(angle=45, margin = margin(t=20, r=100)))+
    labs(title="Total richness over time", y="Species Richness", x="Time since exclosure (years)") +
    scale_x_discrete(labels=c("Grubbed" = "0", "2020" = "1", "2016" = "5", "2010" = "10", "Reference" = "> 20"))
MIE_box
#ggsave("MIE_TotalRichness_boxplot.svg")

#########################################
# native richness 
#########################################


MIE_native <-ggplot(data=MIE, 
    aes(x= Exclosure_date,
    y=Native_richness, group=Exclosure_date)) +
    geom_boxplot(size=1, alpha = 1/10)+ theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free")+ 
    theme(panel.spacing.x = unit(1.25, "lines")) +
    theme(axis.text.x = element_text(angle=45, margin = margin(t=20, r=100)))+
    labs(title="Native richness over time", y="Native Species Richness", x="Time since exclosure") 
MIE_native

#########################################
# non-native richness 
#########################################

MIE_invasive <-ggplot(data=MIE, 
    aes(x= Exclosure_date,
    y=Non_native_richness, group=Exclosure_date)) +
    geom_boxplot(size=1, alpha = 1/10)+ theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free")+ 
    theme(panel.spacing.x = unit(1.25, "lines")) +
    theme(axis.text.x = element_text(angle=45, margin = margin(t=20, r=100)))+
    labs(title="Non-native richness over time", y="Non-native Species Richness", x="Time since exclosure") 
MIE_invasive

#########################################

```

``` {r What are the changes in species cover (total, native, invasive) between estuaries over time?}

MIE_long$Exclosure_date <- factor(MIE_long$Exclosure_date, levels = c("Grubbed", "2020", "2016", "2010", "Reference"))
MIE_long$Estuary <- factor(MIE_long$Estuary, levels = c("Little_Qualicum", "Nanaimo"),
                  labels = c("Little Qualicum", "Nanaimo"))

# this file uses dplyr and plyr. plyr package is loaded second second, so R defaults to summarize function of the plyr package. Must specify which package (dplyr) to run function 'summarise'
# MIE_abund <- MIE_long %>% 
#   group_by(Estuary, Exclosure_date, Species) %>% 
#   dplyr::summarise(
#     n = n(),
#     mean = mean(Cover, na.rm = TRUE),
#     sd = sd(Cover, na.rm = TRUE),
#     se = sd/sqrt(n))

#########################################
# stacked barchart with y-axis showing total % of species cover (position = "fill") 
#########################################

ggplot(MIE_fn_gp, aes(fill=Functional_groups, y=Cover, x=Exclosure_date)) + 
    geom_bar(position="fill", stat="identity") + theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free") + 
    theme(text = element_text(size = 14)) +
    theme(panel.spacing.x = unit(1.25, "lines")) +
    #theme(axis.text.x = element_text(margin = margin(t=20, r=100)))+
    labs(y="Relative Abundance 
         (% cover)", x="Time since exclosure (years)") +
    scale_fill_manual(name = "Plant Functional Group", values = c("#80B1D3", "#B3DE69", "#FDB462", "#BC80BD")) +
    scale_x_discrete(labels=c("Grubbed" = "0", "2020" = "1", "2016" = "5", "2010" = "10", "Reference" = "> 20"))
ggsave("MIE_FnGp_stacked_bar.svg")



#########################################
#native vs. non-native
#########################################


ggplot(MIE_long, aes(fill=Endemic, y=Cover, x=Exclosure_date)) + 
    geom_bar(position="fill", stat="identity") + theme_classic()+
  theme_classic() +
  theme(text = element_text(size = 20)) +
  theme(panel.spacing.x = unit(1.25, "lines")) +
  facet_grid(~Estuary, scales = "free", space = "free") +
  labs(y="Abundance (% cover)", x="Time since exclosure (years)") +
  scale_x_discrete(labels=c("Grubbed" = "0", "2020" = "1", "2016" = "5", "2010" = "10", "Reference" = "> 20")) 
ggsave("MIE_RelAbund_endemism_stacked_bar.svg")



```

``` {r seed bank diversiy}

# see figs at https://www.researchgate.net/figure/Relationship-between-seed-bank-a-species-richness-Yrichness-023Xage-3453-P00001_fig3_260161720

seedling_data <- read.csv("2021_Seedlings_wider.csv", header = TRUE) 
seedling_data$Estuary <- as.character(seedling_data$Estuary)
seedling_data$Exclosure_date <- factor(seedling_data$Exclosure_date, levels = c("Grubbed", "2020", "2016", "2010", "Reference"))

seedling_data$Estuary <- factor(seedling_data$Estuary, levels = c("Englishman", "Little_Qualicum", "Nanaimo"),
                  labels = c("Englishman", "Little_Qualicum", "Nanaimo"))

seedlings <- seedling_data %>%  select(Estuary, Exclosure_date, Replicate, Atriplex_patula:Species_L)

#uses library(plyr)

#####################################
# Seed species richness per exclosure age
#####################################

seed_rich <- ddply(seedlings, ~Estuary*Exclosure_date*Replicate, function (x) (
  data.frame(RICHNESS = sum(x [,-c(1:3)]>0))
))

mean_seed_rich <- setNames(aggregate(seed_rich[,4], list(seed_rich$Estuary, seed_rich$Exclosure_date), mean), c("Estuary", "Exclosure_date", "Mean_seed_richness"))

# Englishman	Grubbed	3.166667		
# Little_Qualicum	Grubbed	3.800000		
# Nanaimo	Grubbed	3.166667		
# Little_Qualicum	2020	4.333333		
# Little_Qualicum	2016	4.166667		
# Englishman	Reference	3.166667		
# Little_Qualicum	Reference	5.333333		
# Nanaimo	Reference	3.166667	

#####################################
# Seedling abundance per exclosure age
#####################################

seed_abund <- ddply(seedlings, ~Estuary*Exclosure_date*Replicate, function (x) (
  data.frame(ABUNDANCE = sum(x [,-c(1:3)]))
))

mean_seed_abund <- setNames(aggregate(seed_abund[,4], list(seed_rich$Estuary, seed_abund$Exclosure_date), mean), c("Estuary", "Exclosure_date", "Mean_seed_abundance"))
# Englishman	Grubbed	39.000000		
# Little_Qualicum	Grubbed	45.000000		
# Nanaimo	Grubbed	21.833333		
# Little_Qualicum	2020	20.000000		
# Little_Qualicum	2016	13.000000		
# Englishman	Reference	6.833333		
# Little_Qualicum	Reference	18.833333		
# Nanaimo	Reference	8.666667	
```

```{r standing:seed richness}

MIE_seed_pl_rich <- inner_join(mean_MIE_pl_rich, mean_seed_rich, by = c("Estuary" = "Estuary", "Exclosure_date" = "Exclosure_date"))

MIE_seed_pl_rich$Exclosure_date <- factor(MIE_seed_pl_rich$Exclosure_date, levels = c("Grubbed", "2020", "2016", "2010", "Reference"))
MIE_seed_pl_rich$Estuary <- factor(MIE_seed_pl_rich$Estuary, levels = c("Englishman", "Little_Qualicum", "Nanaimo"),
                  labels = c("Englishman", "Little Qualicum", "Nanaimo"))

ggplot(data = MIE_seed_pl_rich, 
      aes(x = Mean_species_richness, y = Mean_seed_richness, color = Exclosure_date)) +
      facet_wrap(~ Estuary) +
      scale_y_continuous(name = "Mean seed bank species richness", limits = c(2.5, 6.5)) +
      scale_x_continuous(name = "Mean mature vegetation species richness", limits = c(2.5, 7.5)) +
      scale_color_discrete(name = "Time since exclosure (years)", labels = c("0", "1", "5", ">20")) +
      geom_point(size = 6) + theme_classic() +
      theme(panel.spacing = unit(2, "lines")) +
      theme(text = element_text(size = 20)) +
      theme(legend.position = "bottom", legend.box = "horizontal") 

```

```{r LM}
# tinkering - delete later
###############################################
##### https://www.statology.org/variance-inflation-factor-r/
#fit the regression model

CALY_LM <- MIE_long %>% select(Estuary, Exclosure_age_yr, Plot_elev_m_AMLL, Species, Cover, Site_no) %>% 
  group_by(Exclosure_age_yr) %>% 
  mutate(Sedge_Cover = Cover/100) %>% 
  mutate(Exclosure_age_yr=ifelse(Exclosure_age_yr=="25", "20", Exclosure_age_yr)) %>% 
  filter(Species == "Carex_lyngbyei")

CALY_LM$Exclosure_age_yr <- as.integer(CALY_LM$Exclosure_age_yr)

LM <- lm(Sedge_Cover ~ Exclosure_age_yr + Plot_elev_m_AMLL + Estuary, data = CALY_LM)

#view the output of the regression model
summary(LM)
 
library(car)
vif(LM) # Plot elev VIF > 5

# visualize VIF values
#create vector of VIF values
vif_values <- vif(LM)

#create horizontal bar chart to display each VIF value
barplot(vif_values, main = "VIF Values", horiz = TRUE, col = "steelblue")

#add vertical line at 5
abline(v = 5, lwd = 3, lty = 2)

###############################################

```

```{r LM & GLMM - LQRE & NRE}
# https://bbolker.github.io/mixedmodels-misc/ecostats_chap.html

# pkgs_CRAN <- c("lme4","MCMCglmm","blme",
#                "pbkrtest","coda","aods3","bbmle","ggplot2",
#                "reshape2","plyr","numDeriv","Hmisc",
#                "plotMCMC","gridExtra","R2admb",
#                "broom.mixed","dotwhisker")
# install.packages(pkgs_CRAN)
# install.packages("glmmTMB")
# rr <- "http://www.math.mcmaster.ca/bolker/R"
# install.packages("glmmADMB",type="source",repos=rr)
library("devtools") 
library("lme4")
#library("glmmADMB")      ## (not on CRAN)
library("glmmTMB")


CALY_prop <- MIE_long %>% select(Estuary, Exclosure_age_yr, Plot_elev_m_AMLL, Species, Cover, Site_no) %>% 
  group_by(Exclosure_age_yr) %>% 
  mutate(Sedge_Cover = Cover/100) %>% 
  mutate(Exclosure_age_yr=ifelse(Exclosure_age_yr==25, 20, Exclosure_age_yr)) %>% 
  filter(Species == "Carex_lyngbyei")

CALY_prop$Exclosure_age_yr <- as.integer(CALY_prop$Exclosure_age_yr)

library(ggpmisc)
# adding regression eqn/r^2 w/ stat_poly_eq, see https://stackoverflow.com/questions/7549694/add-regression-line-equation-and-r2-on-graph, from Pedro (~1/3 down the page)
my.formula <- y ~ x

p <- ggplot(CALY_prop,aes(x=Exclosure_age_yr,y=Sedge_Cover,colour=Estuary)) +
  geom_point()+
  geom_smooth(method="lm",alpha=0.3) +
  stat_poly_eq(formula = my.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  labs(x = "Time since exclosure (years)", y = "Avg. proportion sedge cover", colour = "Estuary", caption = "geom_point() + geom_smooth(method = lm, alpha = 0.3)") +
  theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 12), 
    legend.text = element_text(size = 14, face ="bold", colour ="black"), 
    legend.position = "bottom", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) +
  scale_x_continuous(breaks = c(0,5,10,15,20), labels = c("0", "5", "10", "15", ">20")) +
  expand_limits(y = c(0, 1))
p
ggsave("MIE_lm.svg")


# https://cran.r-project.org/web/packages/glmmTMB/vignettes/glmmTMB.pdf
data("Owls")
head(Owls)

Owls <- transform(Owls,
Nest=reorder(Nest,NegPerChick),
NCalls=SiblingNegotiation,
FT=FoodTreatment)

fit_zipoisson <- glmmTMB(NCalls~(FT+ArrivalTime)*SexParent+
offset(log(BroodSize))+(1|Nest),
data=Owls,
ziformula=~1,
family=poisson)

summary(fit_zipoisson)


glmmTMB_poisson <- glmmTMB(Sedge_Cover ~ Exclosure_age_yr+Plot_elev_m_AMLL + (1|Estuary),
                data=CALY_prop,
                ziformula=~1,
                family=poisson)
summary(glmmTMB_poisson)

library(ggeffects)
glmmTMB_predict <- ggpredict(glmmTMB_poisson, c("Plot_elev_m_AMLL", "Exclosure_age_yr"))
plot(glmmTMB_predict)

ggplot(CALY_prop,aes(x=Exclosure_age_yr,y=Sedge_Cover,colour=Estuary)) +
  geom_point()+
  geom_smooth(method="lm",alpha=0.3) 


# see also # https://easystats.github.io/see/articles/performance.html

``` 

```{r GLMM - attempt 2}
#https://quantdev.ssri.psu.edu/sites/qdev/files/ILD_Ch04_2017_GeneralizedMLM.html
CALY_GLMM2 <- MIE_long %>% select(Estuary, Exclosure_age_yr, Plot_elev_m_AMLL, Species, Cover) %>% 
  group_by(Exclosure_age_yr) %>% 
  mutate(Sedge_Cover = Cover/100) %>% 
  mutate(Exclosure_age_yr=ifelse(Exclosure_age_yr=="25", "20", Exclosure_age_yr)) %>% 
  filter(Species == "Carex_lyngbyei")

CALY_GLMM2$Exclosure_age_yr <- as.integer(CALY_GLMM2$Exclosure_age_yr)

#faceted plot
ggplot(data=CALY_GLMM2, aes(x=Exclosure_age_yr,y=Sedge_Cover)) +
  geom_point() + #(position=position_jitter(h=.025)) + 
  xlab("Time since exclosure") + 
  ylab("Relative sedge abundance") + 
  scale_x_continuous(labels = c("0", "5", "10", "15", ">20"),breaks=c(0,5,10, 15,20)) + 
  scale_y_continuous(limits=c(0,1), breaks=c(0,1)) +
  facet_wrap( ~ Estuary)

# unconditional means model
um.fit <- glmer(formula = Sedge_Cover ~ 1 + (1|Estuary), 
              data=CALY_GLMM2,
              family="binomial",
              na.action=na.exclude)
summary(um.fit)


# Add predictor 'Exclosure age'
model1.fit <- glmer(formula = Sedge_Cover ~ 1 + Exclosure_age_yr + 
                      (1|Estuary), 
                    data=CALY_GLMM2,
                    family="binomial",
                    na.action=na.exclude)
summary(model1.fit)

# Odds Ratio Estimates
exp(fixef(model1.fit))

#with confidence intervals 
exp(cbind(OR = fixef(model1.fit), confint(model1.fit, method="Wald")[-1,]))

# Lets look at predicted scores. This can be done in two ways.
# 1. We can predict in the link scale (for us that is log odds), or
# 2. We can predict in the response scale (for us that is probability).
CALY_GLMM2$pred.m1logit <- predict(model1.fit, type="link")
CALY_GLMM2$pred.m1prob <- predict(model1.fit, type="response")

#Logit predictions
ggplot(data=CALY_GLMM2, aes(x=Exclosure_age_yr,y=pred.m1logit, group=Estuary)) +
  geom_line() + 
  xlab("Time since exclosure (years)") + 
  ylab("Sedge Cover") 

#Probability predictions
ggplot(data=CALY_GLMM2, aes(x=Exclosure_age_yr,y=pred.m1prob, group=Estuary)) +
  geom_line() + 
  xlab("Time since exclosure (years)") + 
  ylab("Sedge Cover") 

# We solve for p, which is easily calculated in R using an inv.logit() function in the gtools package.
#install.packages("gtools")
library("gtools")
inv.logit(fixef(model1.fit)[1])

# expand the model to include all the predcitors and covariates
model2.fit <- glmer(formula = Sedge_Cover ~ 1 + Exclosure_age_yr + Plot_elev_m_AMLL +
                      (1|Estuary), 
                    data=CALY_GLMM2,
                    family="binomial",
                    na.action=na.exclude)
summary(model2.fit)

#Using the glmmTMB function in the glmmTMB package.

model2.check <- glmmTMB(formula = Sedge_Cover ~ 1 + Exclosure_age_yr + Plot_elev_m_AMLL + (1|Estuary),
                    family = binomial, 
                    data = CALY_GLMM2
                    #na.action=na.exclude
                    )
summary(model2.check)

# generate predicted scores
CALY_GLMM2$pred.m2logit <- predict(model2.fit, type="link")
CALY_GLMM2$pred.m2prob <- predict(model2.fit, type="response")

#Logit predictions
ggplot(data=CALY_GLMM2, aes(x=Exclosure_age_yr,y=pred.m2logit, group=Estuary)) +
  geom_line() + 
  xlab("Time since exclosure (years)") + 
  ylab("Sedge Cover") 

#Probability predictions
ggplot(data=CALY_GLMM2, aes(x=Exclosure_age_yr,y=pred.m2prob, group=Estuary)) +
  geom_line() + 
  xlab("Time since exclosure (years)") + 
  ylab("Sedge Cover") 


```

```{r GLM - attempt 1)}

# http://r-eco-evo.blogspot.com/2017/05/generalized-linear-models.html 
## good basic English explanation explains concepts like error; 
##regular linear models have limits [-oo; oo], but this won't work for data w/ probabilities restricted [0;1] like proportions
## predictions are made through a predictor function (which is non-linear), which requires a link function (which linearizes the predictor function)
## "family defines the distribution of the errors and chooses the appropriate link function. In R the two most commonly used families are Poisson and Binomial. Poisson is commonly used for counts, while the Binomial family is used in proportions or dichotomous response variables"
## "If the data shows a greater variance than expected by the (Poisson/Binomial) distribution, we have overdispersion. When over dispersion occurs the fitted model  and the estimated parameters are biased and should not be used."  
### Overdispersion usually means that a covariate which has an important effect on the response variable was omitted. 


########################################
# CALY
########################################

# Select relevant data for glm of just CALY cover, convert cover values % to proportion
LQRE_CALY_prop <- MIE %>% select(Estuary, Exclosure_date, Plot_elev_m_AMLL, Agropyron_repens:Triglochin_maritima) %>% pivot_longer(Agropyron_repens:Triglochin_maritima, names_to = "Species", values_to = "Cover") %>% 
  group_by(Exclosure_date) %>% 
  mutate(Cover = Cover/100) %>% 
  filter(Species == "Carex_lyngbyei", Estuary == "Little_Qualicum")

# fit model of effect of exclosure age on CALY cover using Poisson distribution, which uses log link function. 
CALY_glm <- glm(Cover~Exclosure_date*Plot_elev_m_AMLL, data=LQRE_CALY_prop, family=poisson)
summary(CALY_glm) # all age classes significant - should be compared to Grubbed (?)

# Need to check dispersions
1-pchisq(CALY_glm$deviance,CALY_glm$df.residual) # 1 ??

# check significance of model by deviance test: 
anova(CALY_glm, test = "Chisq") #interaction of exclosure age & elevation significant

#recall coefficients
coef(CALY_glm)

## this thing takes forever 
# get 95% CIs for coefficients
#exp(confint(CALY_glm))

# Estimate R^2 as ratio of null and residual deviances. 
1 - (CALY_glm$dev/ CALY_glm$null) # Approx. 74% of variance in CALY cover is explained by variance in plot age and elev. 

# "In order to plot the observed and the expected curve, we need to calculated predicted values as we did in the post where we calculated confidence intervals for regression lines. "
xv <- seq(0,30, length=1000)
su.pre <- predict(CALY_glm, list(area=xv), type="response") # removed argument "se=T"
plot(Cover~Exclosure_date*Plot_elev_m_AMLL, data=LQRE_CALY_prop, xlim=c(0,30), ylab="Carex cover (proportion)", xlab="Years since exclosure") # can't find object 'Exclosure_age_yr' ??
lines(su.pre$fit~xv) # get an error here - 'variable lengths differ'
lines(su.pre$fit+su.pre$se.fit ~ xv, lty=2)
lines(su.pre$fit-su.pre$se.fit ~xv, lty=2)

# See other tutorials 
# http://environmentalcomputing.net/linear-regression/
# https://www.umass.edu/landeco/teaching/ecodata/schedule/methods1.pdf


#http://environmentalcomputing.net/generalised-linear-models/
#http://environmentalcomputing.net/generalised-linear-models-1/
#http://environmentalcomputing.net/intro-to-gams/

```



```{r maps - tutorial}

# tutorial from https://r-spatial.org/r/2018/10/25/ggplot2-sf.html

#install.packages(c("cowplot", "googleway", "ggplot2", "ggrepel", "ggspatial", "libwgeom", "rgeos" "sf", "rnaturalearth", "rnaturalearthdata"))


# library("ggplot2")
# theme_set(theme_bw())
# library("sf")
# 
# library("rnaturalearth")
# library("rnaturalearthdata")
# 
# world <- ne_countries(scale = "medium", returnclass = "sf")
# class(world)
# 
# ggplot(data = world) +
#     geom_sf()
# 
# ggplot(data = world) +
#     geom_sf() +
#     xlab("Longitude") + ylab("Latitude") +
#     ggtitle("World map", subtitle = paste0("(", length(unique(world$NAME)), " countries)"))
# 
# ggplot(data = world) + 
#     geom_sf(color = "black", fill = "lightgreen")
# 
# ggplot(data = world) +
#     geom_sf(aes(fill = pop_est)) +
#     scale_fill_viridis_c(option = "plasma", trans = "sqrt")
# 
# # change projection & extent
# ggplot(data = world) +
#     geom_sf() +
#     coord_sf(crs = "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs ")
# 
# # extent of the map can also be set in coord_sf, in practice allowing to “zoom” in the area of interest, provided by limits on the x-axis (xlim), and on the y-axis (ylim). Note that the limits are automatically expanded by a fraction to ensure that data and axes don’t overlap; it can also be turned off to exactly match the limits provided with expand = FALSE
# 
# ggplot(data = world) +
#     geom_sf() +
#     coord_sf(xlim = c(-123.20, -123.00), ylim = c(49.15, 49.05), expand = TRUE)
# 
# # stopped tutorial b/c not high enough resolution 
# 
# # see blog https://www.molecularecologist.com/2012/09/18/making-maps-with-r/
# #install.packages("RgoogleMaps")
# #library(RgoogleMaps)
# lat <- c(48, 50) #define our map's ylim
# lon <- c(-125,-118) #define our map's xlim
# center = c(mean(lat), mean(lon))  #tell what point to center on
# zoom <- 5  #zoom: 1 = furthest out (entire globe), larger numbers = closer in
# terrmap <- GetMap(center=center, zoom=zoom, maptype= "terrain", destfile = "terrain.png") #lots of visual options, just like google maps: maptype = c("roadmap", "mobile", "satellite", "terrain", "hybrid", "mapmaker-roadmap", "mapmaker-hybrid")
# 
# lat <- c(49,49.15)  #now we are plotting the map
# lon <- c(-123.3,-123.1)
# terrain_close <- GetMap.bbox(lonR= range(lon), latR= range(lat), center= c(49.1, -123.13), destfile= "terrclose.png", zoom=13, maptype="terrain")
# # this doesn't make a map; only spits out a matrix. 
# 
# 
# # see https://journal.r-project.org/archive/2013-1/kahle-wickham.pdf 





```

```{r prep for ANCOVA of Carex cover - test for normality}
# modified from https://www.rpubs.com/cwoods/ancova

#from example: "epiphyte abundance" = "Carex_lyngbyei" or "Richness"
#               "tree size" = "Time_since_exclosure"
#               "location" = "Estuary"

#questions: does the (1) abundance of Carex, (2) species richness vary with time since exclosure and location on the island?
#response (dependent) variable: Carex abundance (continuous), species richness (continuous)
#explanatory (covariate) variable 1: time (continuous)
#explanatory (independent) variable 2: location (categorical)
#test name: ANCOVA

## untransformed data are not normal. Note that raw data were entered as a proportion, so range of data is 0-1. Sqrt transformation only marginally compresses data distribution, but could be used to transform to test a normal distribution (see chunk 'sqrt transformed')




#create a scatterplot with a line for each group of the categorical variable
#################
# CALY cover in all sites 
#################
View(MIE)
p_CALY <- ggplot(MIE, (aes(x=Exclosure_age_yr, y=Carex_lyngbyei, color=Estuary, shape=Estuary))) + theme_classic() +ylab("Carex Abundance") + xlab("Time since exclosure (years)") 
p_CALY + geom_jitter() + geom_smooth(method=lm, se=FALSE, fullrange=TRUE)

CALY <- MIE %>% 
  group_by(Estuary, Exclosure_date) %>% 
  select(CALY_cover = "Carex_lyngbyei")

CALY_box <-ggplot(data=CALY, 
    aes(x= Exclosure_date,
    y=CALY_cover, group=Exclosure_date)) +
    theme(text = element_text(size = 20)) +
    geom_boxplot(size=1, alpha = 1/10)+ theme_classic()+
    facet_grid(~Estuary, scales = "free", space = "free")+ 
    theme(panel.spacing.x = unit(1.25, "lines")) +
    #theme(axis.text.x = element_text(angle=45, margin = margin(t=20, r=100)))+
    labs(title = "Carex cover abundance over time", y="Carex lyngbyei cover abundance (%)", x="Time since exclosure (years)") +
    scale_x_discrete(labels=c("Grubbed" = "0", "2020" = "1", "2016" = "5", "2010" = "10", "Reference" = "> 20"))
CALY_box
#ggsave("CALY_abund_box.svg")

#run a 2-way anova for the data to test model assumptions
ancova_CALY <- lm(Carex_lyngbyei~Exclosure_age_yr*Estuary*Plot_elev_m_AMLL, data=MIE)

#code to create the density plot of residuals
plot(density(ancova_CALY$residuals))

#library(stats)
#create a Q-Q plot
qqnorm(ancova_CALY$residuals)
qqline(ancova_CALY$residuals, datax = FALSE, distribution = qnorm, probs = c(0.25, 0.75)) 

#create a fitted values vs residuals plot
plot(ancova_CALY$residuals~ancova_CALY$fitted.values)
lines(lowess(ancova_CALY$fitted.values,ancova_CALY$residuals), col="blue")
text(ancova_CALY$fitted.values, ancova_CALY$residuals, row.names(MIE), cex=0.6, pos=4, col="red")

#################
# Richness
#################

p_richness <- ggplot(MIE, (aes(x=Exclosure_age_yr, y=Richness, color=Estuary, shape=Estuary))) + theme_classic() +ylab("Species Richness") + xlab("Time since exclosure (years)") 
p_richness + geom_jitter() + geom_smooth(method=lm, se=FALSE, fullrange=TRUE)

#run a 2-way anova for the data to test model assumptions
ancova_richness <- lm(Richness~Exclosure_age_yr*Estuary*Plot_elev_m_AMLL, data=MIE)

#code to create the density plot of residuals
plot(density(ancova_richness$residuals))

#library(stats)
#create a Q-Q plot
qqnorm(ancova_richness$residuals)
qqline(ancova_richness$residuals, datax = FALSE, distribution = qnorm, probs = c(0.25, 0.75)) 

#create a fitted values vs residuals plot
plot(ancova_richness$residuals~ancova_richness$fitted.values)
lines(lowess(ancova_richness$fitted.values,ancova_richness$residuals), col="blue")
text(ancova_richness$fitted.values, ancova_richness$residuals, row.names(MIE), cex=0.6, pos=4, col="red")

anova(ancova_CALY) # very important to note that planting restoration has been done in only the 1-year old plots (2020 exclosures), therefore unsurprising that Exclosure_age_yr is highly significant in ANCOVA results

anova(ancova_richness)

```

``` {r linear regression of ANCOVA - richness }

#https://bookdown.org/ndphillips/YaRrr/linear-regression-with-lm.html 

# Create a linear model of richness given age of exclosure, estuary location, and elevation

MIE_elev <- select(MIE, Plot_elev_m_AMLL, Estuary, Site_no)

MIE_rich_elev <- inner_join(MIE_pl_rich, MIE_elev, by = c("Estuary", "Site_no"))

# MIE_pl_rich must be two objects - RICHNESS changes to ABUNDANCE
richness_lm <- lm(formula = RICHNESS~Exclosure_date*Estuary*Plot_elev_m_AMLL, data=MIE_rich_elev)
summary(richness_lm)


# The coefficients of richness model
summary(richness_lm)$coefficients

# Add the fitted values as a new column in the dataframe
MIE_rich_elev$value_lm <- richness_lm$fitted.values

# Plot the relationship between true estuary richness and linear model fitted values

plot(x = MIE_rich_elev$RICHNESS, 
     y = richness_lm$fitted.values, 
     xlab = "Observed Richness",
     ylab = "Model Fitted Values", 
     main = "Regression fits of species richness")
abline(b = 1, a = 0)



LQRE_richness<-MIE_rich_elev[which(MIE_rich_elev$Estuary=='Little_Qualicum'),]
#ERE_richness<-MIE_rich_elev[which(MIE_rich_elev$Estuary=='Englishman'),]
NRE_richness<-MIE_rich_elev[which(MIE_rich_elev$Estuary=='Nanimo'),]

#explore data (look for outliers)

p_LQRE_richness <- ggplot(LQRE_richness, (aes(x=Exclosure_date, y=RICHNESS))) + theme_classic() +ylab("Species Richness") + xlab("Time since exclosure (years)") 
p_LQRE_richness + geom_smooth(method=lm, se=FALSE, fullrange=TRUE) + geom_abline()


attach(LQRE_richness)
plot(LQRE_richness$Exclosure_date, LQRE_richness$RICHNESS, xlab="Time since exclosure (years)", ylab="Species Richness", pch=19)


#run the linear regression
LQRE_richness_fit<-lm(RICHNESS~Exclosure_date, data=LQRE_richness)

summary(LQRE_richness_fit)$r.squared
#0.1791

#create a density plot of residuals
plot(density(LQRE_richness_fit$residuals))

###############################################################################
# Alternate method from http://www.sthda.com/english/articles/40-regression-analysis/168-multiple-linear-regression-in-r/ 
###############################################################################

MIE_elev <- select(MIE, Estuary, Site_no, Plot_elev_m_AMLL) 

MIE_rich_elev <- inner_join(MIE_pl_rich, MIE_elev, by = c("Estuary", "Site_no"))

richness_lm <- lm(formula = RICHNESS~Exclosure_date*Estuary*Plot_elev_m_AMLL, data=MIE_rich_elev)
summary(richness_lm)



model <- lm(RICHNESS ~ Estuary + Exclosure_date + Plot_elev_m_AMLL, data = MIE_rich_elev)
# any significant p-value indicates the predictor variable (Estuary, Exclosure_date, Plot_elev) is significantly related to the outcome variable (RICHNESS)
summary(model)

#For a given the predictor, the t-statistic evaluates whether or not there is significant association between the predictor and the outcome variable, that is whether the beta coefficient of the predictor is significantly different from zero.
summary(model)$coefficient


#confidence interval of the model coefficient can be extracted
confint(model)



```

``` {r ANCOVA - sqrt transformed data}

############################################
# Square root transformation yields (marginally more) normally distributed residuals
############################################

#square-root transform your response variable Carex_lyngbyei
sqrtCarex = sqrt(MIE$Carex_lyngbyei)

#run the ancova test on the transformed data
ancova_sqrt <-lm(sqrtCarex~Exclosure_age_yr*Estuary*Plot_elev_m_AMLL, data=MIE)


#create the density plot of residuals
plot(density(ancova_sqrt$residuals)) 


#create a Q-Q plot
qqnorm(ancova_sqrt$residuals)
qqline(ancova_sqrt$residuals, datax = FALSE, distribution = qnorm, probs = c(0.25, 0.75)) # better, but not great - residuals don't leap off the top of qq line as far


#create a fitted values vs. residuals plot
plot(ancova_sqrt$residuals~ancova_sqrt$fitted.values)
lines(lowess(ancova_sqrt$fitted.values,ancova_sqrt$residuals), col="blue")
text(ancova_sqrt$fitted.values, ancova_sqrt$residuals, row.names(sqrtCarex), cex=0.6, pos=4, col="red")



############################################
# Add transformed data to dataset
############################################

MIE_xform <- mutate(MIE, 
       Carex_sqrt = sqrtCarex)
#head(estuaries_xform)

#View(MIE_xform)


############################################
# Interpreting ANCOVA Output
############################################

anova(ancova_sqrt)



```

``` {r linear regression of ANCOVA - CALY }


#To report the results of each of your explanatory variables (Exclosure_age_yr and Estuary separately), you need to conduct and report the results of separate simple linear regressions for each group individually.

LQRE<-MIE_xform[which(MIE_xform$Estuary=='Little_Qualicum'),]
#ERE<-MIE_xform[which(MIE_xform$Estuary=='ERE'),]
NRE<-MIE_xform[which(MIE_xform$Estuary=='Nanaimo'),]

#explore data (look for outliers)
attach(LQRE)
plot(LQRE$Exclosure_age_yr, LQRE$Carex_sqrt, xlab="Time since exclosure (years)", ylab="Carex lyngbyei abundance (square root)", pch=19)
abline(lm(Carex_sqrt~Exclosure_age_yr), col="red")

#run the linear regression
fit<-lm(Carex_sqrt~Exclosure_age_yr, data=LQRE)

summary(fit)$r.squared
#0.0785

#create a density plot of residuals
plot(density(fit$residuals))

#####
# note - repeat this for each estuary location
#####


############################################
# plot the sqaure root transformed cover data  
############################################
p_sqrt <- ggplot(MIE_xform, (aes(x=Exclosure_age_yr, y=Carex_sqrt, color=Estuary, shape=Estuary))) + theme_classic() +ylab("Carex Abundance (square root)") + xlab("Time since exclosure (years)") 
p_sqrt + geom_point() + geom_smooth(method=lm, se=FALSE, fullrange=TRUE)

# How to handle/characterize transplanting 



```






